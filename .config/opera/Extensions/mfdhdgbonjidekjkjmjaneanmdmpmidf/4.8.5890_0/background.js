'use strict';var trup,init,sycl,cfgo,uris,dast,perm,blak,scbr,scma,exts,down;
Registry.require("promise statistics convert xmlhttprequest downloads tools storage uri compat parser layout helper syncinfo notify asker i18n native".split(" "),function(){var n=Registry.log,p=rea.FEATURES,ia=function(){var d=[],e=!0,g=function(d,g,c){var a={title:d.join("\n\n")};g.path=rea.extension.getURL("images/icon"+(g.frag?"_"+g.frag:"")+".png");n.warn(d.join("\n"));rea.browserAction.setIcon({path:g.path});rea.browserAction.setTitle(a);g=function(a,c,k){a={name:"1",sub_menu_item:!0,pos:"left",
items:[]};a.items.push({name:d[0],image:"info"});1<d.length&&a.items.push({name:d[1]});k({items:[a],options:{enabled:!1}})};c||rea.extension.onMessage.addListener(g)};return{run:function(){try{Registry.verify("5890").length&&(e=!1,g(["Tampermonkey detected that browser is caching some outdated code parts.","In order to avoid unexpected behavior TM will be kept paused until your browser was restarted."],{frag:"paused"}))}catch(d){e=!1,n.error(d.message)}if("chromeStorage"==p.DB.USE&&!p.DB.NO_WARNING){var A=
function(){if(!t)return window.setTimeout(A,2E3);t.isWorking().fail(function(){confirm("Tampermonkey detected that the extension storage is unreliable!\n\nUnfortunately this means that all your settings and userscripts are inaccessible at the moment.\n\nDo you want to visit the FAQ entry that explains how to recover from that?")&&rea.tabs.create({url:"https://tampermonkey.net/faq#Q206"},function(){});g(["Tampermonkey detected that the extension storage is unreliable!"],{frag:"paused"},!0)})};window.setTimeout(A,
1E3)}return e},pause:g,setWarning:function(g,e,c){d.push({text:g,description:e,url:c})},getWarnings:function(){return d}}}();if(ia.run()){var m=Registry.get("promise"),v=Registry.get("helper"),wa=Registry.get("tools"),N=Registry.get("statistics"),t=Registry.get("storage"),S=Registry.get("notify"),W=Registry.get("asker"),Q=Registry.get("native"),ja=Registry.get("permission"),ka=Registry.get("layout"),B=Registry.get("uri"),d=Registry.get("i18n"),I=Registry.get("downloads"),L=wa.cache,J=Registry.get("convert");
uris=B;down=I;perm=ja;dast=t;var xa=v.createUUID(),fa={};n.debug("Starting background fred @"+xa);L.create("rundata").setOptions({timeout:5,check_interval:10,retimeout_on_get:!0}).init();L.create("regexp").setOptions({timeout:300,check_interval:120,retimeout_on_get:!0}).init();var Ea=function(){var d=m(),q,g,h=rea.extension.manifest.version,l=t.getSchemaVersion(),c=l;t.getVersion("0.0.0.0").then(function(a){g=a;q=E.versionCmp(h,g)==E.versionCmp.eNEWER;return t.isWiped()}).then(function(a){!q&&a&&
(a=["Tampermonkey detected inconsistencies that indicate that your browser wiped the extension database!","You can continue to use Tampermonkey normally, but your settings and scripts might be lost. Click here to get more information.","https://tampermonkey.net/faq.php#Q207"],n.warn(a.join("\n")),ia.setWarning.apply(this,a))}).always(function(){var a=[],b=0,f=function(){if(b<a.length){var k=a[b].schema;a[b].cond(k)?a[b].fn().done(function(){k&&(n.log("Converted database from",c,"to",k),c=k);b++;f()}).fail(function(){d.reject()}):
(b++,f())}},k=function(){n.warn("Incognito mode detected. Database conversion can only be done in non-incognito mode! Stopping now...");ia.pause(["Tampermonkey needs to convert its database but this can't be done in incogonito mode!","Please open a non-incognito mode window and/or restart your browser."],{frag:"paused"})},a=[{cond:function(){return q&&!p.RUNTIME.FIREFOX&&!p.RUNTIME.EDGE&&"chromeStorage"==p.DB.USE&&!t.getValue(p.CONSTANTS.STORAGE.LEGACY_VERSION)&&E.versionCmp("3.5.3603",g)==E.versionCmp.eNEWER},
fn:function(){var a=m();rea.extension.inIncognitoContext?(k(),a.reject()):(n.log("Update database..."),c="3.5.3603",t.migrate("sql","chromeStorage").done(function(){n.log("Copied config for default usage of chrome storage");a.resolve()}));return a.promise()}},{cond:function(){return q&&E.versionCmp("3.6.3650",c)==E.versionCmp.eNEWER&&E.versionCmp("3.5.3650",g)==E.versionCmp.eNEWER},fn:function(){var a=m();if(rea.extension.inIncognitoContext)k(),a.reject();else{c="3.6.3650";var b=[];[{o:"TM_config",
n:p.CONSTANTS.STORAGE.CONFIG},{o:"TM_update_check",n:p.CONSTANTS.STORAGE.UPDATE},{o:"TM_version"},{o:"TM_unload_ts"}].forEach(function(a){if(a.n){var c=t.getValue(a.o);void 0!==c&&b.push(t.setValue(a.n,c))}b.push(t.deleteValue(a.o))});var f=/@re$/,d=[];t.listValues().forEach(function(a){-1!=a.search(f)&&(a=a.replace(f,""),d.push(a))});d.forEach(function(a){var c=t.getValue(a+"@st"),f=t.getValue(a),k=t.getValue(a+"@re"),d=t.getValue(a+"@source"),u=z.getUidByName(a)||v.createUUID();b.push(t.deleteValue(a+
"@st"));b.push(t.deleteValue(a));b.push(t.deleteValue(a+"@re"));b.push(t.deleteValue(a+"@source"));f&&k&&d?(b.push(t.setValue(p.CONSTANTS.PREFIX.SCRIPT_UID+u,a)),b.push(t.setValue(p.CONSTANTS.PREFIX.COND+u,k)),b.push(t.setValue(p.CONSTANTS.PREFIX.STORE+u,c)),b.push(t.setValue(p.CONSTANTS.PREFIX.SCRIPT+u,d)),b.push(t.setValue(p.CONSTANTS.PREFIX.META+u,f))):n.warn("invalid script entry",{source:d,meta:f,cond:k})});f=/@st$/;t.listValues().forEach(function(a){-1!=a.search(f)&&b.push(t.deleteValue(a))});
m.when(b).done(function(){n.log("Converted database from",g,"to",c);a.resolve()})}return a.promise()}},{schema:"3.7.0",cond:function(a){return E.versionCmp(a,c)==E.versionCmp.eNEWER},fn:function(){var a=m();if(rea.extension.inIncognitoContext)k(),a.reject();else{var b=[],c=new RegExp("^"+p.CONSTANTS.PREFIX.META);t.listValues().forEach(function(a){if(-1!=a.search(c)){var f=t.getValue(a);f.options&&f.options.override&&!f.options.override.orig_run_at&&(f.options.override.orig_run_at=f.options.run_at||
"document-idle",f.options.run_at=null,b.push(t.setValue(a,f)))}});m.when(b).done(function(){a.resolve()})}return a.promise()}},{schema:"4526",cond:function(a){return q&&p.RUNTIME.SAFARI&&"chromeStorage"==p.DB.USE&&E.versionCmp(a,c)==E.versionCmp.eNEWER},fn:function(){var a=m();if(rea.extension.inIncognitoContext)k(),a.reject();else{n.log("Update database...");var b=t.migrate("localStorage","chromeStorage").done(function(){n.log("Copied config for default usage of setting storage")});a.consume(b)}return a.promise()}},
{schema:"4871",cond:function(a){return q&&E.versionCmp(a,c)==E.versionCmp.eNEWER},fn:function(){var a=m(),b,f,c=t.getValue(p.CONSTANTS.STORAGE.CONFIG);c&&c.scriptTemplate&&(f=e.getDefaults())&&(b=f.script_templates)&&b[0]&&b[0].value&&(b[0].value=c.scriptTemplate,delete c.scriptTemplate,t.setValue(p.CONSTANTS.STORAGE.CONFIG,c));a.resolve();return a.promise()}},{schema:"5465",cond:function(a){return E.versionCmp(a,c)==E.versionCmp.eNEWER},fn:function(){var a=m();if(rea.extension.inIncognitoContext)k(),
a.reject();else{var b=t.getValue(p.CONSTANTS.STORAGE.CONFIG);b&&1==b.sync_version&&(b.sync_enabled=!1,t.setValue(p.CONSTANTS.STORAGE.CONFIG,b));a.resolve()}return a.promise()}},{cond:function(){return q||E.versionCmp(c,l)==E.versionCmp.eNEWER},fn:function(){var a=m();t.setVersion(h,c).done(function(){a.resolve()});return a.promise()}},{cond:function(){return q},fn:function(){n.log("First run of version "+h+"!");za.scheduleNotification(g,"0.0.0.0"==g);return m.Pledge()}},{cond:function(){return!0},
fn:function(){var a=m();d.resolve();window.setTimeout(a.resolve,p.MISC.TIMEOUT);return a.promise()}}];f()});return d.promise()},Y=function(){return{get:function(d,q){var g=(0==d)+"#"+q,h=L.items.rundata.getj(g);if(h)h=h.oldret;else{var h=[],l=[],c=[],a={};if(q)for(var b=w.determineScriptsToRun(q,!0),f=0;f<b.length;f++){var k=b[f];w.isContexter(k)||0!=d&&(!0===k.options.noframes||null===k.options.noframes&&!0===k.options.override.orig_noframes)||(k.evilness&&k.evilness>=Math.min(K.SEVERITY_MAX,e.values.script_blacklist_severity)?
c.push(k):k.enabled?(a[k.uuid]=q,h.push(k)):l.push(k))}h={runners:h,disabled:l,evilness:c,script_map:a};q&&L.items.rundata.setj(g,{frameId:d,oldret:h})}return h},answer:function(d,q){var g=v.select(d,function(a){return a}),h=[{m:"native",t:[I.staticVars.DEFAULT,I.staticVars.NATIVE]},{m:"disabled",t:[I.staticVars.OFF]},{m:"browser",t:[I.staticVars.CHROME]}].filter(function(a){if(-1!=a.t.indexOf(e.values.downloads_mode))return!0}).map(function(a){return a.m})[0]||"disabled",l=rea.extension.inIncognitoContext,
c=!l&&"off"!=e.values.external_connect&&w.validUrl(q,Aa.externally_connectable_reg);return{scripts:g,contexters:ma.getContexterCount(),raw:{},external_connect:c,inIncognitoContext:l,downloadMode:h,enforce_strict_mode:"on"==e.values.runtime_strict_mode,statistics:N.isActive("api"),measure_scripts:e.values.debug,logLevel:e.values.logLevel,version:rea.extension.manifest.version}},getContexters:function(d,e){for(var g=[],h=w.determineScriptsToRun(e),l=0;l<h.length;l++){var c=h[l];c.enabled&&(0==d||!0!==
c.options.noframes&&(null!==c.options.noframes||!0!==c.options.override.orig_noframes))&&w.isContexter(c)&&g.push(c)}return g}}}(),F=function(){var d={},q=1,g=q++,h=q++,l=q++,c=q++,a=q++,b=q++,f=q++,k=function(){var a={frames:{0:{state:g}},tabs:{reset_ts:Date.now()},scripts:{},urls:{},maps:{},contexts:{onUnload:{}},stats:{running:0,disabled:0},extra:{}};Object.defineProperties(a.urls,{length:{value:0,enumerable:!1,writable:!0,configurable:!0}});return a},u={updateStats:function(a,b,c,f){d[a].stats.running+=
c;d[a].stats.disabled+=f;d[a].contexts.onUnload[b]=d[a].contexts.onUnload[b]||[];d[a].contexts.onUnload[b].push(function(){d[a].stats.running-=c;d[a].stats.disabled-=f});d[a].tabs.ts=Date.now()},updateMaps:function(a,b,c){var f=1,k=function(b,c){var k=1===f;void 0===d[a].maps[c]&&k&&(d[a].maps[c]={count:0,all_time:0,urls:[]});k&&(d[a].maps[c].urls.push(b),d[a].maps[c].all_time++);d[a].maps[c].count+=f};v.each(c,k);d[a].contexts.onUnload[b]=d[a].contexts.onUnload[b]||[];d[a].contexts.onUnload[b].push(function(){d[a]&&
(f=-1,v.each(c,k))})},updateUrls:function(a,b,c){var f=function(f){1===f&&(void 0===d[a].urls[c]?d[a].urls[c]={frameId:b,count:0}:0===b&&(d[a].urls[c].frameId=b));d[a].urls[c].count+=f;d[a].urls.length=-1};f(1);d[a].contexts.onUnload[b]=d[a].contexts.onUnload[b]||[];d[a].contexts.onUnload[b].push(function(){d[a]&&f(-1)})},determine:function(a,b,c){var f;T.isAllowed(c)?f=Y.get(b,c):(n.debug("This URL is filtered by the security settings:",c,"-> Do nothing!"),F.set.forbidden(a,b),f={runners:[],disabled:[],
evilness:[],script_map:{}});d[a].scripts[c]=f;f.runners.forEach(function(c){c.webRequest&&ga.scripts.set(a,b,c.uuid,c.webRequest)});return f.runners.length},run:function(a,b,c,f,k){a=[];for(b=0;b<f.length;b++)a.push(Ca.bundle({url:c},f[b]));var d;m.when(a).always(function(a){k?k(a):d=a});return d}},r={},D={},y={},x={},C={listeners:{once:{whenReady:function(a,b){if(!d[a]||d[a].frames[0].state<l)C.listeners.once.onReady(a,b);else b()},onReady:function(a,b){var c=function(a){C.listeners.remove.onCommited(f);
C.listeners.remove.onCompleted(k);a&&b()},f=C.listeners.add.onCommited(function(b){b===a&&c(!0)}),k=C.listeners.add.onCompleted(function(b){b===a&&c(!0)})}},add:{onReset:function(a){var b=v.createUUID();r[b]=a;return b},onCommited:function(a){var b=v.createUUID();D[b]=a;return b},onCompleted:function(a){var b=v.createUUID();y[b]=a;return b},onRemoved:function(a){var b=v.createUUID();x[b]=a;return b}},remove:function(){return{onReset:function(a){delete r[a]},onCommited:function(a){delete D[a]},onCompleted:function(a){delete y[a]},
onRemoved:function(a){delete x[a]}}}()},events:{reset:function(a,b){var c;p.RUNTIME.FAST_EXEC_SUPPORT&&(c=d[a])&&Object.keys(c.frames).forEach(function(b){C.events.clean(a,b)});c=d[a]=k();c.frames[0].state=g;v.each(r,function(c){c&&c(a,b)})},response:function(a,b,c){if(e.values.enabled){var f=d[a]=d[a]||k(),r=f.frames[b]=f.frames[b]||{},x=r.state||g;0===b&&(f.tabs.response_ts=Date.now());c=B.woHash(c);x<h&&(u.determine(a,b,c),r.state=h);return(a=f.scripts[c])?a.runners.length:0}},commited:function(a,
b,c){if(e.values.enabled){var f=B.parse(c);if("http:"===f.protocol||"https:"===f.protocol||"file:"===f.protocol){var f=d[a]=d[a]||k(),f=f.frames[b]=f.frames[b]||{},r=f.state||g;r>=l||(f.state=l,r<h&&(c=B.woHash(c),u.determine(a,b,c)),v.each(D,function(b){b&&b(a)}))}}},loading:function(a,b,f){if(e.values.enabled){var r=B.parse(f);if(("http:"===r.protocol||"https:"===r.protocol||"file:"===r.protocol)&&0===b&&"file:"===r.protocol){r=d[a]=d[a]||k();r.frames[b]=r.frames[b]||{};var x=r.frames[b].state||
g;x>=c||(r.frames[b].state=c,x<h&&(f=B.woHash(f),u.determine(a,b,f)))}}},run:function(b,c,f,r,g){if(e.values.enabled){var x=0===c||p.RUNTIME.FAST_EXEC_SUPPORT?c:f,D=d[b]=d[b]||k();D.frames[x]=D.frames[x]||{};var h=B.woHash(r),y=D.scripts[h];if(!y&&(n.debug("tv: lazy init @ events.run("+b+", "+c+", "+f+", "+r+")"),u.determine(b,c,h),y=D.scripts[h],!y)){n.warn("tv: no script run info for tab "+b+" @ "+h,n.D?D.scripts:"");return}f=D.frames[x].state;D.frames[x].state=a;f!=a&&(u.updateMaps(b,x,y.script_map),
u.updateUrls(b,x,h),u.updateStats(b,x,y.runners.length,y.disabled.length));return u.run(b,c,h,y.runners,g?function(a){C.events.clean(b,x,r);g(a)}:null)}},clean:function(a,b,c){if(e.values.enabled){var f,k;if(f=d[a])c&&(c=B.woHash(c),delete f.scripts[c]),(k=F.get.objurl(a,b))&&URL.revokeObjectURL(k)}},complete:function(c,f,r){r=B.parse(r);if(e.values.enabled&&("http:"===r.protocol||"https:"===r.protocol||"file:"===r.protocol)){if(0===f){var x=d[c]=d[c]||k();x.frames[f]=x.frames[f]||{};var u=x.frames[f].state||
g;x.frames[f].state=b;if(!F.get.empty(c)&&F.get.stats(c).running){if(u<a){n.warn("tv: no script run info!");return}"file:"===r.protocol?window.setTimeout(function(){rea.tabs.sendMessage(c,{method:"onLoad",frameId:f},function(){})},500):rea.tabs.sendMessage(c,{method:"onLoad",frameId:f},function(){})}}v.each(y,function(a){a&&a(c)})}},unload:function(a,b,c){c=0===b||p.RUNTIME.FAST_EXEC_SUPPORT?b:c;p.RUNTIME.FAST_EXEC_SUPPORT&&C.events.clean(a,b);a=d[a]=d[a]||k();a.frames[c]=a.frames[c]||{};a.frames[c].state=
f;if(a.contexts.onUnload[c]){for(b=0;b<a.contexts.onUnload[c].length;b++)a.contexts.onUnload[c][b]();a.contexts.onUnload[c]=[]}},remove:function(a){var b;p.RUNTIME.FAST_EXEC_SUPPORT&&(b=d[a])&&Object.keys(b.frames).forEach(function(b){C.events.clean(a,b)});delete d[a];v.each(x,function(b){b&&b(a)})}},set:{extra:function(a,b,c,f){a=d[a]=d[a]||k();null===b?a.extra[c]=f:(a.extra[c]=a.extra[c]||{},a.extra[c][b]=f)},objurl:function(a,b,c){C.set.extra(a,b,"objurl",c)},blocker:function(a){C.set.extra(a,
null,"blocker",!0)},forbidden:function(a,b){0===b&&C.set.extra(a,null,"forbidden",!0)},requests:function(a,b,c,f){a=d[a]=d[a]||k();b=a.frames[b]=a.frames[b]||{};(b.requests=b.requests||{})[c]=f}},get:{extra:function(a,b,c,f,k){void 0===f&&(f=null);a=(d[a]?d[a].extra:{})[c];null!==b&&a&&k&&delete a[b];return a||f},empty:function(a){var b=!0;if(d[a]&&0!=d[a].urls.length){if(-1==d[a].urls.length)return d[a].urls.length=0,v.each(d[a].urls,function(b,c){"length"!==c&&0<b.count&&d[a].urls.length++}),C.get.empty(a);
b=!1}return b},urls:function(a,b){var c;return b?(c=d[a].maps[b])?c.urls:[]:(c=d[a])?c.urls:{}},history:function(a){return d[a].maps},stats:function(a,b){var c={};d[a]&&(c.running=d[a].stats.running,c.disabled=d[a].stats.disabled,b&&(c.unique=0,Object.keys(d[a].maps).forEach(function(b){0<d[a].maps[b].count&&c.unique++})));return c},tabs:function(){var a={};v.each(d,function(b,c){a[c]={ts:b.response_ts}});return a},objurl:function(a,b){return C.get.extra(a,b,"objurl",null,!0)},blocker:function(a){return C.get.extra(a,
null,"blocker")},forbidden:function(a){return C.get.extra(a,null,"forbidden")},requests:function(a,b){return d[a]&&d[a].frames[b]?d[a].frames[b].requests:null}}};return C}(),na=function(){var d={};return{get:function(e,g){d[e]||(d[e]={});d[e][g]||(d[e][g]={});return d[e][g]},getAll:function(e){var g={};Object.keys(d).forEach(function(h){g[h]={};g[h]=d[h][e]});return g},set:function(e,g,h){d[e]||(d[e]={});var l={};h&&Object.keys(h).forEach(function(c){l[c]=h[c]});d[e][g]=l},cleanTab:function(e){delete d[e]}}}(),
oa=function(){return{isScriptUrl:function(d,e){if(!d||-1!=d.search(/\#bypass=true/)||-1!=d.search(p.REQUESTS.GET_INTERNAL_PAGE_REGEXP())||"data:"===d.substr(0,5))return!1;var g=e?d:d.split(/[\?#$]/)[0],h=-1!=g.search(/.+\.user\.(js\#|js\?|js$)/)||-1!=g.search(/.+\.tamper\.(js\#|js\?|js$)/);return h?!(-1!=g.search(/^htt[ps]{1,2}:\/\/code\.google\.com/)||-1!=g.search(/^htt[ps]{1,2}:\/\/(github|gitlab)\.com/)&&!w.determineOriginOfUrl(g)||-1!=g.search(/^htt[ps]{1,2}:\/\/bitbucket\.org/)&&!w.determineOriginOfUrl(g)):
h}}}(),T=function(){return{init:function(){var d=function(){L.items.regexp.remove("PageFilter")};e.addChangeListener("forbiddenPages",d);e.addChangeListener("page_whitelist",d);e.addChangeListener("page_filter_mode",d)},isAllowed:function(d){var q=!1,g=!1,h=M.getSyncRemoteDomains().map(function(a){return"*://"+a+"/*"}),h=e.values.forbiddenPages.concat(h),l=0!=h,c=0!=e.values.page_whitelist.length;switch(e.values.page_filter_mode){case "black":g=l;break;case "off":break;case "white":q=c;break;default:q=
c,g=l}(l=L.items.regexp.get("PageFilter"))||(l=w.regexify({inc:q?e.values.page_whitelist:void 0,exc:g?h:void 0}),L.items.regexp.set("PageFilter",l));return!g&&!q||w.validUrl(d,l)}}}(),K=function(){var A=function(d,h){var e=!1;if(h.length)return(e="/"==h.substr(0,1)?w.matchUrl(d,w.convertToRegExp(h)):-1!=d.search(h))&&n.debug('black: entry "'+h+'" matched'),e},q={SEVERITY_MAX:10,SEVERITY_MANUALLY_DEFINED:11,SEVERITY_FOISTED_SCRIPT:12,init:function(){var d=m(),h=function(){"server"===e.values.script_blacklist_type&&
window.setTimeout(q.checkUpdate,2E4)};h();e.addChangeListener("script_blacklist_type",h);d.resolve();return d.promise()},getWarningsFor:function(g){var h=[];g&&v.each(e.values.script_blacklist_server,function(e){if(e){var c;v.each(e.rules,function(a){c|=A(g,a);return 1!=c});if(c)if(e.reasons){var a=Object.keys(e.reasons),b,f;void 0!==(b=d.getBestLocale(a))&&(f=a[b]);h.push(e.reasons[f||"en"])}else e.reason&&h.push(e.reason)}});return h},getEvilnessOf:function(d){if("off"===e.values.script_blacklist_type)return!1;
if(!d)return 0;var h=!1,l=0;v.each(e.values.require_blacklist,function(c){h|=A(d,c);return 1!=h});h?l=q.SEVERITY_MANUALLY_DEFINED:"server"===e.values.script_blacklist_type&&v.each(e.values.script_blacklist_server,function(c){if(c&&(v.each(c.rules,function(a){h|=A(d,a);return 1!=h}),h))return l=c.severity,!1});return Number(l)},checkUpdate:function(d){var h=m(),l=Z.getConfig(),c;if(d||6048E5<Date.now()-l.black.last){var a=function(a,c){var d=m();aa.internal({method:"GET",url:a,nocache:c,retries:p.XMLHTTPREQUEST.RETRIES,
overrideMimeType:"text/plain; charset=x-user-defined"},{ondone:function(a){d.resolve(a)}});return d.promise()};a("https://blacklist.tampermonkey.net/get.php?version=get").then(function(b){if(4==b.readyState&&200==b.status){try{c=JSON.parse(b.responseText).version}catch(f){n.warn("black: unable to parse version response! "+b.responseText)}n.info("black: local version: "+l.black.version+" remote: "+c);if(c>l.black.version||d)return a("https://blacklist.tampermonkey.net/get.php",!0)}}).then(function(a){if(a&&
4==a.readyState&&200==a.status)try{var c=JSON.parse(a.responseText);c&&c.blacklist&&1==c.version&&(e.values.script_blacklist_server=c.blacklist);n.info("black: updated blacklist to ",c)}catch(d){n.warn("black: blacklist update failed! ",a.responseText)}}).always(function(){l=Z.getConfig();l.black.last=Date.now();l.black.version=c||l.black.version;Z.setConfig(l);h.resolve()})}else h.resolve();return h.promise()}};return q}();blak=K;var Ga=function(){for(var d=[],e=[],g=0;g<d.length;g++){var h=Registry.getRaw("system/"+
d[g]+".tamper.js");h&&e.push(h)}return e},M=function(){var A=0,q=[],g={to:null,force:null,t:0},h={},l=wa.createQueue(1),c={},a=function(a){return l.add(function(){n.debug("sync: import",a.uuid,a.name,a.url);var b={imported:e.values.sync_type},c={},f;for(f in y.SYNCED)!0===y.SYNCED[f]&&(c[f]=a.options[f]);var d={uuid:a.uuid,ask:!1,internal:!0,sync:b,force_meta:{lastModified:a.lastModified,fileURL:a.url},force_options:c},k={silent_fail:!0};return G.caps.syncsSource?G.getSource(a.uuid).then(function(a){return w.installFromSource(a,
d,k)}):w.installFromUrl(a.url,d,k)})},b=function(a,b){return l.add(function(){if(!G.caps.syncsSource){var c;if(!a.url||!(c=B.parse(a.url))||!c.protocol.match(/https?:/))return n.debug("sync: skip export due to missing URL",a.name,a.url),m.Pledge(!1)}n.debug("sync: export",a.name,a.url);return G.setMeta(a,{lastModified:a.lastModified}).then(function(){if(G.setSource&&b)return G.setSource(a.uuid,b)}).then(function(){return!0})})},f=function(a){var b=a.downloadURL?a.downloadURL.split("#")[0]:null,c=
a.fileURL?a.fileURL.split("#")[0]:null,f=v.select([c,b],function(a){if(!a||"file:"!==B.parse(a).protocol)return a})[0],b={uuid:a.uuid,name:a.name,options:{},durl:b,furl:c,url:f,lastModified:a.lastModified||a.lastUpdated},d;for(d in y.SYNCED)!0===y.SYNCED[d]&&null!==a.options[d]&&(b.options[d]=a.options[d]);return b},k=function(){var a=[];z.getUidList().forEach(function(b){b=z.getByUid(b);if(b.script&&b.cond){var c=f(b.script);c.lastModified||Registry.isDevVersion("test")?b.script.evilness&&b.script.evilness>=
Math.min(K.SEVERITY_MAX,e.values.script_blacklist_severity)?n.warn("sync: ignore evil script",b.script):a.push(c):n.warn("sync: script without updated/modified timestamps found",b.script)}});return a},u=function(f){if(y.enabled)if(0<A)f&&y.addSyncDoneCallback(function(a){a&&y.sync(50,f)});else{A++;var r=null,g=null,u=0,D=0,l=!0,p=function(a){if(a)for(var b=0;b<g.length;b++)if(g[b].uuid==a)return g[b];return null},t=function(a){if(!a)return null;for(var b=0;b<r.length;b++)if(r[b].uuid==a)return r[b]},
Fa=function(a,b,c){return c?Math.floor(a/c)*c>Math.floor(b/c)*c:a>b},v=function(a,b,c){return c?Math.floor(a/c)*c<Math.floor(b/c)*c:a<b},B=function(a,b,c){return c?Math.floor(a/c)*c!=Math.floor(b/c)*c:a!=b};O.all("status",{key:"sync_status",class:"information",title:d.getMessage("Script_Sync"),text:d.getMessage("Sync_is_running"),timeout:9E5});return m.Pledge().then(function(){r=k();return G.list().done(function(a){g=a}).fail(function(){n.warn("sync: unable to get remotelist!")})}).then(function(){var b=
g.map(function(b){var f,k=t(b.uuid),r,g;if(k){if(!b.lastModified&&e.values.sync_type==G.types.eCHROMESYNC)for(var D in y.SYNCED)if(!0===y.SYNCED[D]&&k.options[D]!=b.options[D]){n.debug("sync: importable change detected!",b.name,"key:",D,b);r=!0;break}b.lastModified&&v(k.lastModified,b.lastModified,b.precision)&&(g=b.lastModified,r=!0,n.debug("sync: importable change detected!",b.name,"local ts:",new Date(k.lastModified),"remote ts:",new Date(b.lastModified),b))}else(f=c[b.uuid])&&b.lastModified&&
v(f.lastModified,b.lastModified,b.precision)&&(g=b.lastModified,r=!0,n.debug("sync: changed cache entry detected!",b.name,"local ts:",new Date(f.lastModified),"remote ts:",new Date(b.lastModified),b));if(!k&&!f||r)return function(){return m.Pledge().then(function(){return G.caps.specialMeta?G.getMeta(b.uuid):m.Pledge(b)}).then(function(b){if(b){var D;if(k)if(b.options.removed)u++,n.debug("sync: remove local script",b.uuid,b.name,b.url),w.doRemove(k.uuid,!1);else{if(r){B(g,b.lastModified,b.precision)&&
(b.lastModified&&n.warn("sync: list and meta data lastModified differ, this will cause extra traffic!","file ts:",new Date(g),"meta ts:",new Date(b.lastModified),b),b.lastModified=g);u++;n.debug("sync: update local script",b.uuid,b.name,b.url);var x=z.getByUid(k.uuid);if(x.script&&x.cond){for(D in y.SYNCED)!0===y.SYNCED[D]&&(x.script.options[D]=b.options[D]);x.script.lastModified=b.lastModified;return m.Pledge().then(function(){if(G.caps.syncsSource){var a=m();G.getSource(b.uuid,x.script.textContent).done(function(a){x.script.textContent=
a}).fail(function(){n.warn("sync: getting source of",b.uuid,"failed",b)}).always(a.resolve);return a.promise()}}).then(function(){return w.doModify(x.script.uuid,x.script,!1)})}n.warn(d.getMessage("fatal_error")+"("+k.name+")!!!")}}else if(k||b.options.removed)!f&&b.options.removed&&(c[b.uuid]=b);else if(D=m(),b.url&&h[b.url]||b.uuid&&h[b.uuid])n.warn("sync: skip previously failed import",b);else return a(b).done(function(a){a?u++:(n.warn("sync: unable to import",b),h[b.url]=!0,h[b.uuid]=!0)}).fail(function(){n.warn("sync: unable to load",
b);h[b.url]=!0;h[b.uuid]=!0}).always(D.resolve),D.promise()}})}}).filter(function(a){return a});return m.onebyone(b)}).then(function(){u&&(w.reorderScripts(),O.all("status",{key:"sync",class:"information",title:d.getMessage("Script_Sync"),text:d.getMessage("0count0_changes_imported",u),timeout:1E4}));r=k();return m.Pledge()}).then(function(){for(var a=[],c=0;c<r.length;c++)a.push(function(){var a=r[c],f,d;if(!G.caps.syncsSource&&!a.url)return m.Pledge();var k=p(a.uuid);if(k){if(!k.lastModified||Fa(a.lastModified,
k.lastModified,k.precision))f=!0,n.debug("sync: exportable change detected!",a.name,"remote ts:",new Date(k.lastModified),"local ts:",new Date(a.lastModified),a)}else n.debug("sync: export because remotely missing!",a.name,"local ts:",new Date(a.lastModified),a);return!k||f||G.caps.syncsSource&&!k.source?(G.caps.syncsSource&&(f=z.getByUid(a.uuid),f.script&&f.cond&&(d=f.script.textContent)),b(a,d).then(function(a){a&&D++})):m.Pledge()}());return m.when(a)}).fail(function(){l=!1}).done(function(){l=
!0}).always(function(){n.debug("sync: finished");if(0==--A){O.all("status",{key:"sync_status",class:"information",title:d.getMessage("Script_Sync"),text:d.getMessage("Sync_finished"),timeout:15E3});D&&O.all("status",{key:"sync",class:"information",title:d.getMessage("Script_Sync"),text:d.getMessage("0count0_changes_exported",D),timeout:5E3});for(var a=l;q.length;)q.shift()(a)}})}},r=function(){y.enabled&&y.sync(500,!0)},D=null,y={enabled:!1,SYNCED:{comment:!0},configChangeListener:function(){D||(D=
window.setTimeout(function(){D=null;y.init().done(function(){y.enabled&&y.sync(3E3)})},3E3))},init:function(){var a=m();y.enabled=!1;(function(){return e.values.sync_enabled&&e.values.sync_type?G.init(e.values.sync_type,{url:e.values.cloud_url,basic_auth:J.Base64.encode(e.values.cloud_user+":"+e.values.cloud_pass)}).done(function(a){y.enabled=a;y.enabled?G.addChangeListener(r):n.warn("sync: init failed!")}).fail(function(){n.warn("sync: init failed!")}):m.Pledge()})().always(function(){a.resolve(y.enabled)});
return a.promise()},finalize:function(){},reset:function(){return y.enabled?G.reset():m.Breach()},addSyncDoneCallback:function(a){q.push(a)},sync:function(a,b){var c=Date.now();a=a||500;b=g.force||b;g.to?(window.clearTimeout(g.to),g.ts<c+a&&(a=g.ts-c,1>a&&(a=1))):n.debug("sync: schedule sync for run in "+a+" ms");g.force=b;g.ts=c+a;g.to=window.setTimeout(function(){u(g.force);g.to=null;g.force=null},a)},scriptAddedCb:function(a,c){if(y.enabled){var d=f(c);b(d,c.textContent)}},scriptChangedCb:function(){y.enabled&&
y.sync(6E4)},scriptRemovedCb:function(a,b){if(y.enabled){var c=f(b);n.debug("sync: remove",c.name,c.url);G.remove(c)}},getSyncRemoteUrl:function(a){if(y.enabled)return G.getRemoteUrl(a)},getSyncRemoteDomains:function(){return G.getRemoteDomains()||[]}};return y}();sycl=M;var Ha=function(){e.addChangeListener(["sync_enabled","sync_type","cloud_url","cloud_user","cloud_pass"],M.configChangeListener);e.addChangeListener("logLevel",function(){n.set(e.values.logLevel)});e.addChangeListener("i18n",function(){d.setLocale(e.values.i18n)});
e.addChangeListener("native_import_path",function(){Q.setPath(e.values.native_import_path)});e.addChangeListener("incognito_mode",function(){Da()});e.addChangeListener("statistics_enabled",function(){N.setEnabled(e.values.statistics_enabled)});e.addChangeListener(["require_blacklist","script_blacklist_server","script_blacklist_type"],w.blackCheckAll);e.addChangeListener(["downloads_extension_whitelist","downloads_mode"],I.config_changed_listener);e.addChangeListener("webrequest_modHeaders",function(d,
e,g,h){h.done(window.setTimeout(V.reset,1))})},e=function(){var d={},e={enabled:!0,configMode:0,debug:!1,logLevel:0,showFixedSrc:!1,webrequest_modHeaders:"yes",webrequest_fixCSP:"yes",webrequest_fixContentCSP:"no",notification_showUpdate:"changelog",notification_silentScriptUpdate:!0,script_templates:[{name:"ECMAScript 5",value:"// ==UserScript==\n// @name         New Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  try to take over the world!\n// @author       You\n// @match        <$URL$>\n// @grant        none\n// ==/UserScript==\n\n(function() {\n    'use strict';\n\n    // Your code here...\n})();"},
{name:"ECMAScript 6",value:'// ==UserScript==\n// @name         New ES6-Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  shows how to use babel compiler\n// @author       You\n// @require      https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.18.2/babel.js\n// @require      https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/6.16.0/polyfill.js\n// @match        <$URL$>\n// ==/UserScript==\n\nvar inline_src = (<><![CDATA[\n\n    // Your code here...\n\n]]\x3e</>).toString();\nvar c = Babel.transform(inline_src, { presets: [ "es2015", "es2016" ] });\neval(c.code);'},
{name:"CoffeeScript",value:"// ==UserScript==\n// @name         New Coffee-Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  shows how to use coffeescript compiler\n// @author       You\n// @require      http://coffeescript.org/browser-compiler/coffeescript.js\n// @match        <$URL$>\n// ==/UserScript==\n\nvar inline_src = (<><![CDATA[\n\n    // Your code here\n\n]]\x3e</>).toString();\nvar compiled = this.CoffeeScript.compile(inline_src);\neval(compiled);"}],
scriptUpdateCheckPeriod:864E5,scriptUpdateHideNotificationAfter:15E3,scriptUpdateCheckDisabled:!1,scriptUrlDetection:"auto",script_file_access:p.RUNTIME.FIREFOX?"off":"externals",runtime_strict_mode:"byscript",runtime_inject_mode:"default",autoReload:!1,appearance_badges:"running",appearance_badge_color:"gcal"===rea.runtime.short_id?"#444":"#ee3131",editor_enabled:!0,editor_fontSize:100,editor_theme:function(){return"default#dark"==k.values.layout?"default-dark":"default"},editor_keyMap:"windows",
editor_indentUnit:4,editor_indentWithTabs:"spaces",editor_tabMode:"indent",editor_electricChars:!0,editor_autoSave:!1,editor_easySave:!0,editor_autoLint:!0,editor_autoLintMaxLen:3E5,editor_lineWrapping:!1,editor_highlightTrailingWhitespace:!0,editor_trimTrailingSpacesFromModifiedLines:!0,editor_linter_config:null,favicon_service:"google",native_import:!0,native_import_path:null,native_import_post_action:"disable",i18n:null,action_menu_columns:1,action_menu_scripts_hide_disabled:!1,action_menu_scripts_sort:"auto",
incognito_mode:"temporary",layout:"default",layout_user_css:"",sync_enabled:!1,sync_type:2,statistics_enabled:p.RUNTIME.FIREFOX&&"firb"!=rea.runtime.short_id?null:!0,downloads_mode:"default",downloads_extension_whitelist:"/^[^\\.]*$/ /\\.mp[34]$/ .wav /\\.(avi|mkv|flv|divx|mpe?g|webm)$/ /\\.(ico|gif|png|jpe?g)/ /\\.(srt|sub|idx)$/ .txt .iso .zip /\\.r(ar|[0-9]{2,2})$/".split(" "),external_update_interval:6048E5,external_connect:"all",require_timeout:2E4,require_blacklist:["/^https?:\\/\\/example.com(:[0-9]{1,5})?\\/.*/"],
require_sri_mode:"supported",script_blacklist_server:[],script_blacklist_type:"server",script_blacklist_severity:4,connect_mode:"ask",page_filter_mode:"black",page_whitelist:["/https?:\\/\\/greasyfork\\.org\\/.*/","http://xkcd.com/970/"],forbiddenPages:"*example.org/* *paypal.tld/* *stripe.com/* https://*deutsche-bank-24.tld/* https://*bankofamerica.tld/* /^.*:\\/\\/apis\\.google\\.com\\/((?!render)([^\\/]+)\\/)+([^\\/]+)?$/ *://www.facebook.com/plugins/* *://platform.twitter.com/widgets/*".split(" ")},
g={cloud_url:null,cloud_user:null,cloud_pass:null},h=function(a){var b;return void 0!==(b=t.getValue(p.CONSTANTS.STORAGE.CONFIG,{})[a])?b:"function"==typeof(b=e[a])?b():b},l=function(a,b){var c=t.getValue(p.CONSTANTS.STORAGE.CONFIG,{}),f=h(a);c[a]=b;var k=t.setValue(p.CONSTANTS.STORAGE.CONFIG,c);d[a]&&JSON.stringify(f)!=JSON.stringify(b)&&d[a].forEach(function(c){try{c(a,f,b,k)}catch(d){n.warn("config: changeListener error",d)}});return k},c,a;if(p.HTML5.LOCALSTORAGE&&(a=p.HTML5.LOCALSTORAGE.getItem(p.CONSTANTS.STORAGE.SESSION)))try{c=
JSON.parse(J.Base64.decode(a))}catch(u){}c=c||{};var b=function(a){var b;return void 0!==(b=c[a])?b:g[a]},f=function(a,f){var k=b(a);void 0===f?delete c[a]:c[a]=f;p.HTML5.LOCALSTORAGE&&p.HTML5.LOCALSTORAGE.setItem(p.CONSTANTS.STORAGE.SESSION,J.Base64.encode(JSON.stringify(c)));d[a]&&JSON.stringify(k)!=JSON.stringify(f)&&d[a].forEach(function(b){try{b(a,k,f)}catch(c){n.warn("config: changeListener error",c)}});return m.Pledge()},k={init:function(){var a=m();k.values={};k.__defineGetter__("snapshot",
function(){return v.assign({},k.values)});Object.keys(e).forEach(function(a){k.values.__defineGetter__(a,function(){return h(a)});k.values.__defineSetter__(a,function(b){l(a,b)})});Object.keys(g).forEach(function(a){k.values.__defineGetter__(a,function(){return b(a)});k.values.__defineSetter__(a,function(b){f(a,b)})});k.initialized=!0;var c=Ga();Object.keys(c).forEach(function(a){var b=c[a];window.setTimeout(function(){w.doSave({url:null,src:b,ask:!1,replace:!0,internal:!0})},1)});a.resolve();return a.promise()},
getValue:function(a){return g.hasOwnProperty(a)?b(a):h(a)},setValue:function(a,b){return g.hasOwnProperty(a)?f(a,b):l(a,b)},getDefaults:function(){return e},addChangeListener:function(a,b){Array.isArray(a)||(a=[a]);a.forEach(function(a){d[a]||(d[a]=[]);d[a].push(b)})}};return k}(),aa=function(){var e,q,g=[],h,l,c,a=function(){return m.sleep(1).then(function(){return rea.permissions.supported?ja.hasOrigin(p.PERMISSIONS.ALL_URLS).then(function(a){return a},function(){return!0}):!0}).always(function(a){(q=
a)?O.removeAll("runtime_host_permissions"):O.all("status",{key:"runtime_host_permissions",class:"warning",text:d.getMessage("Limited_runtime_host_permissions_might_break_some_Tampermonkey_features_"),timeout:31536E6});h=null})},b=function(b,d,u){var r={details:b,callbacks:d,internal:u};g.push(r);m.Pledge().then(function(){if(void 0===q)return c||(ja.addListener(function(b){n.log("pcx: detected permission change",b);q=void 0;h=a()}),c=!0),h||(h=a()),h}).then(function(){return l}).then(function(){var a=
g;g=[];if(q)return a;var b=[],c=a.map(function(a){var c=B.woPath(a.details.url)+"/*";return ja.hasOrigin(c).then(function(a){a||b.push(c)})});return l=m.sidebyside(c).then(function(){b.length&&(n.log("pcx: need to ask for some permissions",b),n.warn("pcx: asking for host permissions is not working yet","https://bugs.chromium.org/p/chromium/issues/detail?id=889654"));return a}).always(function(){l=null})}).always(function(a){a.forEach(function(a){a.aborted||(a.xhr=e(a.details,a.callbacks,a.internal?
{internal:!0}:void 0))})});return{abort:function(){var a;if(r.xhr)return r.xhr.abort();g&&-1!=(a=g.indexOf(r))?g.splice(a,1):r.aborted=!0}}};return{init:function(){e=ba.run},internal:function(a,c){return b(a,c,!0)},external:function(a,c){return b(a,c)}}}(),pa=function(){var d=m();rea.tabs.getSelected(null,function(e){d.resolve(e)});return d.promise()},ha=function(){var d={},q=function(a){if(B.isIpOrHostname(a))return null;var b=a.split(".");if(3>b.length)return a;a=B.isSecondLevelDomain(b.slice(-2).join("."))?
-3:-2;return b.slice(a).join(".")},g=function(a){return a&&-1!=a.indexOf("*")},h=function(a){var b=m();T.isAllowed(a)?b.resolve({allowed:!0}):b.resolve({allowed:!1});return b.promise()},l=function(a,b){var c=function(a){return a?a.map(function(a){if(a.match(/^'?self'?$/))a=B.parse(b.url).hostname||null;else if("'none'"==a)a="none";else if(-1===["none","localhost","*"].indexOf(a)&&!B.isIpOrHostname(a)&&(0===a.indexOf(".")||1===(a.match(/\./g)||[]).length&&B.isSecondLevelDomain(a)))return null;return a}):
[]};return{connects:a.options.override.merge_connects&&"paranoid"!=e.values.connect_mode?c(a.connects):[],userconnects:c(a.options.override.use_connects),blockers:c(a.options.override.use_blockers)}},c=function(a,b,c){var f=m(),k=function(){f.resolve({permitted:!0})},h=function(a){f.resolve({permitted:!1,reason:a})},u=function(){f.resolve({unknown:!0})},l,q=function(a,b){var c=null,f=B.isIpOrHostname(a);b.every(function(b){if(b.a)for(var d=0;d<b.a.length;d++)if(b.a[d]&&(f||B.isIpOrHostname(b.a[d])?
b.a[d]===a:-1!=a.search(new RegExp("(^|.+\\.)"+v.escapeForRegExp(b.a[d])+"$"))))return c=b.blocker?h:k,!1;return!0});return c};if("off"==e.values.connect_mode)k();else if((l=B.parse(c))&&l.hostname)if((c=q(l.hostname,[{a:d[a.uuid]}]))||(c=g(d[a.uuid])?k:null))c();else if(0===b.connects.length&&0===b.userconnects.length&&0===b.blockers.length)"casual"==e.values.connect_mode?k():"strict"==e.values.connect_mode?h("No @connects given, but strict mode enabled"):u();else if(-1!=b.connects.indexOf("none"))h("None value found");
else{if("casual"!=e.values.connect_mode||g(b.blockers)||!(c=g(b.connects)?k:null))(c=g(b.userconnects)?k:null)||(c=q(l.hostname,[{a:b.blockers,blocker:!0},{a:b.connects},{a:b.userconnects}])||u);c()}else h("URL can not be parsed");return f.promise()},a=function(){var a=function(a){for(var b=0;b<f.length;b++)if(f[b].tabId===a)return f.splice(b,1)[0];return f.pop()},c;pa().then(function(f){for(;!b&&(c=a(f.id));)c.fn()})},b,f=[],k=function(c,k,h,u,e){var l,p=m(),X=function(){p.resolve({approved:!0})},
la=function(){p.resolve({forbidden:!0})};n.debug('cor: "'+c.name+'" is asking for permission to access',u,k);if((l=B.parse(u))&&l.hostname){var Ba=q(l.hostname),t=k.tab?k.tab.id:null;b=!0;pa().then(function(a){return W.askForConnect({src_url:k.url,hostname:l.hostname,domain:Ba,all_domains:g(h.connects),tabid:t,active:t===a.id,timeout:e,url:u,settings_url:rea.extension.getURL("options.html")+"#nav="+c.uuid+"+settings",connect_url:"https://tampermonkey.net/documentation.php#_connect",script:{name:c.name,
uuid:c.uuid,icon:c.icon64||c.icon||rea.extension.getURL("images/txt.png")}})}).done(function(a){var b,f=a.whole_domain?Ba:l.hostname;a.allow?a.once?(n.debug('cor: allowing "'+c.name+'" to access',f,"once"),X()):a.temporary?(n.debug('cor: allowing "'+c.name+'" to access',f,"temporarily"),void 0===d[c.uuid]&&(d[c.uuid]=[]),-1==d[c.uuid].indexOf(f)&&d[c.uuid].push(f),X()):(b=X,a.all_domains?(n.debug('cor: allowing "'+c.name+'" to access all domains always'),c.options.override.use_connects.push("*")):
(n.debug('cor: allowing "'+c.name+'" to access',f,"always"),c.options.override.use_connects.push(f),b=X)):a.once||a.aborted?(n.debug('cor: denying "'+c.name+'" to access',f,"once"),la()):(c.options.override.use_blockers||(c.options.override.use_blockers=[]),b=la,a.all_domains?(n.debug('cor: denying "'+c.name+'" to access any domains (additional) domain'),c.options.override.use_blockers.push("*")):(n.debug('cor: denying "'+c.name+'" to access',f,"always"),c.options.override.use_blockers.push(f)));
b&&w.doModify(c.uuid,c,!1).always(b)}).fail(la).always(function(){b=!1;f.length&&window.setTimeout(a,1)})}else la();return p.promise()},u=function(a,d,y,x){var C=l(a,d),q=arguments;return h(y).then(function(b){if(!0!==b.allowed)return m.Breach("URL is blacklisted");var f,k;return(f=B.parse(y))&&f.origin&&(k=B.parse(d.url))&&k.origin&&f.origin===k.origin?m.Pledge({permitted:!0}):c(a,C,y)}).then(function(c){if(!1===c.permitted)return m.Breach("URL is not permitted"+(c.reason?": "+c.reason:""));if(!0===
c.permitted)return m.Pledge();if(0===C.connects.length||g(C.connects)){if(-1==["ask","paranoid"].indexOf(e.values.connect_mode))return m.Breach();if(g(C.blockers))return m.Breach("URL was permanently blocked by the user");if(b){n.debug('cor: queuing access permission check from "'+a.name+'" to',y,d);var h=m();f.push({tabId:d.tab?d.tab.id:null,fn:function(){h.consume(u.apply(this,q))}});return h.promise()}return k(a,d,C,y,x).then(function(a){return!0===a.approved?m.Pledge():m.Breach("Request was blocked by the user")})}return m.Breach("URL is not a part of the @connect list")})};
return{getSessionConnects:function(a){return d[a]||[]},setSessionConnects:function(a,b){d[a]=b||[]},purgeAppeals:function(a){f=f.filter(function(b){return b.tabId!==a})},exec:function(a,b,c,f){var d,k,g,h,e=a.url,l=[],q=Math.max(Math.min(a.timeout||0,6E4),2E4),m=function(){for(var a;!g&&!h&&(a=l.shift());)a()},A=function(b,c){var d='Refused to connect to "'+(c||a.url)+'": '+(b||"Blocked by @connect CORS check"),k=ba.makeErrorResponse(d);["onerror","ondone"].forEach(function(a){if(f[a])f[a]({response:k,
exception:d})})};if(!(c&&c.url&&c.tab&&a.url&&b&&(k=z.getByUid(b))&&k.script&&k.cond))return A();u(k.script,c,a.url,q).done(function(){var b={};Object.keys(f).forEach(function(a){b[a]=function(r){var D=arguments;g||(h?l.push(function(){b[a].apply(this,D)}):function(){return r&&r.finalUrl&&e!==r.finalUrl?(h=!0,u(k.script,c,r.finalUrl,q).fail(function(){g||(d&&d.abort(),g=!0,A("Request was redirected to a not whitelisted URL",r.finalUrl),n.warn("cor: request to",e,"was redirect to a not whitelisted URL",
r.finalUrl))}).always(function(){e=r.finalUrl;h=!1;l.length&&window.setTimeout(m,1)})):{always:function(a){a()}}}().always(function(){if(!g)f[a]({response:r})}))}});d=aa.external(a,b)}).fail(function(a){A(a);n.warn("cor: access to",e,"was denied")});return{abort:function(){g=!0;d&&d.abort()}}}}}(),sa=function(){var d=function(a){var b=[];a=new DataView(a);for(var c=0;c<a.byteLength;c+=4){var d=("00000000"+a.getUint32(c).toString(16)).slice(-8);b.push(d)}return b.join("")},e={md5:function(a,b){return m.Pledge(J.MD5(a,
b))}},g={};["SHA-1","SHA-256","SHA-384","SHA-512"].forEach(function(a){var b=a.toLowerCase().replace("-","");g[b]=function(){var b=function(b,c){var f=m();window.crypto.subtle.digest(a,J.str2arrbuf(b,c)).then(function(a){f.resolve(d(a))},function(){f.reject()});return f.promise()};try{return b("").then(function(a){if(a&&a.substr(0,4).toLowerCase().match(/[0-9a-f]{4,4}/))return b})}catch(c){return m.Breach()}}});var h=function(a){return-1!=Object.keys(e).indexOf(a)},l=function(a){return function(){if(!1!==
c){var b=arguments,f=m();c.push(function(){f.consume(a.apply(this,b))});return f.promise()}return a.apply(this,arguments)}},c=[];return{init:function(){n.D&&Object.keys(e).forEach(function(a){n.debug("sri:",a,"is supported")});return m.sidebyside(Object.keys(g).map(function(a){return g[a]().done(function(b){n.debug("sri:",a,"is supported");e[a]=b}).fail(function(){n.debug("sri:",a,"is unsupported")})})).always(function(){c.forEach(function(a){a()});c=!1})},isSupported:l(function(a){return m.Pledge(h(a))}),
getHash:l(function(a,b){var c=m();"string"===typeof a&&(a=B.parse(a));if(a&&a.hash){for(var k,g,r=a.hash.replace(/^#/,"").split(/,|;/g),e=0;e<r.length;e++)if((g=r[e].match(/([^=|:|-]+)[=|:|-](.+)/))&&3==g.length&&h(g[1])){k=g[2];if(!/^[0-9a-fA-F]+$/.exec(k)){var l;var x=decodeURIComponent(k);try{l=d(J.str2arrbuf(J.Base64.decode(x)))}catch(C){l=null}k=l||k}k={type:g[1],value:k}}c.resolve(k||(b?k:{type:"unsupported",value:""}))}else c.resolve();return c.promise()}),check:l(function(a,b,c){return b&&
a&&h(a.type)?e[a.type](b,c).then(function(b,c){return((c=b===a.value)?m.Pledge:m.Breach)(c||{type:a.type,value:b})}):m.Breach()})}}(),P=function(){var d={key:function(a,b){return p.CONSTANTS.PREFIX.EXTERNAL+v.select([a,b?J.MD5(b):null],function(a){return a}).join(":")},list:function(a){var b=new RegExp("^"+a);return v.select(t.listValues(),function(a){return-1!=a.search(b)})},set:function(a,b,c,k){a=d.key(a,b);var g={};v.each(c,function(a,b){"content"==b&&(b="base",a=J.encodeS(a));g[b]=a});t.setValue(a,
{ts:Date.now(),url:b,resource:g,modified:k})},get:function(a,b){var c=d.key(a,b),c=t.getValue(c),k;if(c&&c.resource){var g={};v.each(c.resource,function(a,b){"base"==b&&(b="content",a=J.decodeS(a));g[b]=a});k={ts:c.ts,url:c.url,data:g,modified:c.modified}}return k},clean:function(a,b){var c=d.key(a,b);t.deleteValue(c)},cleanAll:function(a,b){var c,k=d.list(d.key(a));if(b){var g={};v.each(b,function(b){b=d.key(a,b);g[b]=!0});c=[];v.each(k,function(a){g[a]||c.push(a)})}else c=k;c.forEach(function(a){t.deleteValue(a)})}},
q=function(a,b){var c=m(),d=function(d){var k={content:""};if(4!=d.readyState||200!=d.status&&0!=d.status||d.error)c.reject(k);else{for(var g,h=d.responseHeaders?d.responseHeaders.split("\n"):[],e,r=0;r<h.length;r++){var u=h[r].split(":"),l=u.shift()||"",u=u.join(":")||"";if("content-type"==l.trim().toLowerCase()&&(e=u.match("(image/|text/)([.-a-zA-Z0-9]+)"))){g=e[0];break}}g||(a.match(".*.(ico|jpg|jpeg)+($|\\?|#).*")?g="image/x-icon":(e=a.match(".*.(gif|png)+($|\\?|#).*"))?g="image/"+e[1]:-1!=a.search(".*.(js)+($|\\?|#).*")?
g="text/javascript":(e=a.match(".*.(css|html|xml)+($|\\?|#).*"))?g="text/"+e[1]:v.isLocalImage(a)&&(g="image/x-icon"));k.meta=g;k.content=J.arrbuf2str(d.response,b.encoding)||"";c.resolve(k)}},g=function(){c.reject({})},h=B.parse(a);-1!=["file:",p.REQUESTS.INTERNAL_PAGE_PROTOCOL].indexOf(h.protocol)?"file:"!=h.protocol||p.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS&&-1!=["externals","all"].indexOf(e.values.script_file_access)?rea.file.get(a,function(a){d({readyState:4,status:0,response:a})},function(a){g({error:!0,
responseText:a})}):(n.warn("externals:","Access to this local file is forbidden!","Loading the following @resource failed:",a,"-> more info:","https://tampermonkey.net/faq.php#Q204"),g({error:!0,responseText:"Access to this local file is forbidden!"})):(h={method:"GET",url:a,retries:p.XMLHTTPREQUEST.RETRIES,nocache:!1,responseType:"arraybuffer"},h.timeout=e.values.require_timeout,aa.internal(h,{onload:d,onerror:g,ontimeout:g}));return c.promise()},g=v.getDebouncer(9E3),h=function(a,b,c,k){var g=m(),
h={sync:!1};q(b,{encoding:k.encoding}).done(function(l){c&&(l.sri=c);var q=function(c){var f=B.parse(b);f.protocol&&-1==["file:",p.REQUESTS.INTERNAL_PAGE_PROTOCOL].indexOf(f.protocol)&&d.set(a,b,c)};c&&-1!=["supported","given"].indexOf(e.values.require_sri_mode)?sa.check(c,l.content,k.encoding).done(function(){h.resource=l;q(h.resource);g.resolve(h)}).fail(function(a){h.resource={forbidden:!0,sri:{mode:e.values.require_sri_mode,type:c.type,value:"invalid"},determined:a,content:""};q(h.resource);g.reject(h)}):
(h.resource=l,q(h.resource),g.resolve(h))}).fail(function(c){n.debug("externals: get.failed",a,b,c);h.resource={failed:!0,content:""};g.reject(h)});return g.promise()},l=function(a,b,c){var k=m(),u=B.parse(b),r={sync:c.sync},l;b?K.getEvilnessOf(b)>=e.values.script_blacklist_severity?(r.resource={blacklisted:!0,content:""},k.reject(r)):sa.getHash(u,"supported"==e.values.require_sri_mode).done(function(q){if("enforce"!=e.values.require_sri_mode||q)if("file:"!==u.protocol&&(l=d.get(a,b))){var x=d.key(a,
b),C=Date.now();0<e.values.external_update_interval&&C-l.ts>e.values.external_update_interval&&!g.is(x)&&(1<e.values.external_update_interval&&g.add(x),l.modified?n.debug("externals: resource is not updated due to user modifications",b,(new Date(l.ts)).toISOString(),(new Date(C)).toISOString()):(n.debug("externals: resource needs update",b,(new Date(l.ts)).toISOString(),(new Date(C)).toISOString()),window.setTimeout(function(){h(a,b,q,c)},3E3)));r.resource=l.data;r.resource.forbidden||r.resource.blacklisted?
k.reject(r):k.resolve(r)}else k.consume(h(a,b,q,c));else r.resource={forbidden:!0,sri:{mode:e.values.require_sri_mode},content:""},k.reject(r)}):(r.resource={forbidden:!0,content:""},k.reject(r));return k.promise()},c={setElement:function(a,b,c,k){return d.set(a,b,c,k)},getElement:function(a,b){return d.get(a,b)},cleanElement:function(a,b){return d.clean(a,b)},dropAll:function(a){d.cleanAll(a);return m.Pledge()},dropAllBut:function(a,b){d.cleanAll(a,b);return m.Pledge()},loadResources:function(a,
b){var f=m();c.getResources(a,b).always(function(){f.resolve()});return f.promise()},loadRequires:function(a,b){var f=m();c.getRequires(a,b).always(function(){f.resolve()});return f.promise()},getResources:function(a,b){var c={elements:[]},d=m(),g=[],h={sync:!0};b.forEach(function(b){var d=b.url||B.sanitize(b.unsafe_url,b.abs_url),k={name:b.name,url:d},d=l(a,d,h),e=m();d.done(function(a){a=a.resource;k.content=a.content;k.meta=a.meta||"application"}).fail(function(a){a.resource&&a.resource.forbidden?
a.resource.sri?n.warn("externals: can't load @resource",b.name,"from URL",b.unsafe_url,"due to a SRI error"):n.warn("externals: can't load @resource",b.name,"from forbidden URL",b.unsafe_url):a.resource&&a.resource.blacklisted?n.warn("externals: can't load @resource",b.name,"from blacklisted URL",b.unsafe_url):(n.warn("externals: can't load @resource",b.name,"from URL",b.unsafe_url),k.failed=!0);k.content=null}).always(function(a){h.sync&=a.sync;c.elements.push(k);e.resolve()});g.push(e)});m.when(g).always(function(){c.sync=
h.sync;d.resolve(c)});return d.promise()},getRequires:function(a,b){var c={elements:[]},d=m(),g=[],h={encoding:"UTF-8",sync:!0};v.each(b,function(b,d){var k=b.url||B.sanitize(b.unsafe_url,b.abs_url),e={},k=l(a,k,h),q=m();k.done(function(a){e.textContent=a.resource.content||""}).fail(function(a){a=a.resource&&a.resource.forbidden?a.resource.sri?"couldn't load @require from URL "+b.unsafe_url+" due to a SRI error":"couldn't load @require from forbidden URL "+b.unsafe_url:a.resource&&a.resource.blacklisted?
"couldn't load @require from blacklisted URL "+b.unsafe_url:"couldn't load @require from URL "+b.unsafe_url;e.textContent='console.warn("Tampermonkey: " + decodeURIComponent("'+encodeURIComponent(a)+'"));\n';n.warn("externals: "+a)}).always(function(a){h.sync&=a.sync;c.elements[d]=e;q.resolve()});g.push(q)});m.when(g).always(function(){c.sync=h.sync;c.elements=c.elements.filter(function(a){return a});d.resolve(c)});return d.promise()}};return c}();exts=P;var Ca=function(){var d=function(d,h,l){var c=
m(),a=[];l.forEach(function(b){b=b.textContent||"";b=qa.mkCompat(b,d.options.compatopts_for_requires?d:null,"off"!=e.values.runtime_strict_mode);a.push(b)});l="\n"+a.join("\n")+"\n";var b=z.getStorageByUid(d.uuid);h=qa.mkCompat(h,d,"off"!=e.values.runtime_strict_mode);if(e.values.debug){h=h.split("\n");for(var f=!1,k,u=0;u<h.length;u++)if(k=h[u],!k.match(/^\s*$|^\s*\/\/\s*|^\s*\/\*.*\*\/\s*$|^\s*["']+use strict["']+;*\s*$/))if(k.match(/^\s*\/\*/)&&(f=!0),f)if(k.match(/\*\/\s*$/))f=!1;else{if(-1!=
(k=k.search(/\*\//))){h[u]=v.insert(h[u],k+2,0,"debugger;");break}}else{h[u]="debugger;"+h[u];break}h=h.join("\n")}l={header:d.header,code:h,requires:l,storage:b,script:d,source_url:rea.extension.getURL("userscript.html")+"?id="+d.uuid};c.resolve(l);return c.promise()},q={};return{bundle:function(g,h){var e,c,a=!0;if(e=q[h.uuid])return e;var b={},f="includes matches requires resources excludes connects textContent".split(" ");Object.keys(h).forEach(function(a){-1==f.indexOf(a)&&("options"==a?(b[a]=
JSON.parse(JSON.stringify(h[a])),b[a].run_at=b[a].run_at||h.options.override.orig_run_at||"document-idle"):b[a]=h[a])});e=P.getResources(b.uuid,h.resources).then(function(c){a&&!c.sync&&(n.debug("ri: uncached @external detected -> fast script start disabled"),a=c.sync);b.resources=c.elements;return P.getRequires(b.uuid,h.requires)}).then(function(c){a&&!c.sync&&(n.debug("ri: uncached @external detected -> fast script start disabled"),a=c.sync);c=c.elements;n.debug("run script "+b.name+" @ "+g.url);
return d(b,h.textContent,c)}).always(function(){c=!0;delete q[b.uuid]});c||(q[b.uuid]=e);return e}}}(),O=function(){var d={},e={},g=function(c,a){var b,f=a.key||"general",d=a.timeout||3E5,g=window.setTimeout(function(){delete c[f]},d);(b=c[f])&&window.clearTimeout(b.to);c[f]={ts:Date.now()+d,options:a,to:g}},h=function(c){var a=Date.now();return Object.keys(c).map(function(b){var f=c[b];b=v.copy(f.options,{});if(f=Math.max(0,f.ts-a))return b.timeout=f,b}).filter(function(a){return a})},l={all:function(c,
a){l.actionPage(c,a);l.optionsPage(c,a)},removeAll:function(c){delete d[c];delete e[c]},actionPage:function(c,a){var b=rea.extension.getViews({type:"popup"});b&&b.length&&rea.extension.sendMessage({method:c,options:a},function(){});a&&g(d,a)},optionsPage:function(c,a){var b=rea.extension.getViews({type:"tab"});b&&b.length&&rea.extension.sendMessage({method:c,options:a},function(){});a&&g(e,a)},actionStatus:function(){return h(e)},optionsStatus:function(){return h(d)}};return l}(),Z=function(){return{getConfig:function(){var d=
{version:0,last:0},e={scripts:0},g=t.getValue(p.CONSTANTS.STORAGE.UPDATE,e);"object"!==typeof g&&(g=e);g||(g=e);void 0==g.black&&(g.black=d);void 0==g.scripts&&(g.scripts=0);return g},setConfig:function(d){d&&t.setValue(p.CONSTANTS.STORAGE.UPDATE,d)}}}(),ca=function(){var A=function(h,l){var c=0,a=0,b=0,f=d.getMessage("Script_Update"),k=d.getMessage("Check_for_userscripts_updates")+"...";h&&S.show(f,k,rea.extension.getURL("images/icon128.png"),1E4);var u=z.getUidList().map(function(f){var k,h,u,C,
q,A;return function(){C=z.getByUid(f);if(!C.script||!C.cond)return n.warn("update: inconsistent script entry",f,C),m.Breach();var a=!e.values.scriptUpdateCheckDisabled&&!C.script.enabled&&!l||!C.script.options.check_for_updates;if(l&&C.script.uuid!==l||a||!(A=w.determineSourceURL(C.script))||C.script.evilness&&C.script.evilness>=Math.min(K.SEVERITY_MAX,e.values.script_blacklist_severity))return m.Breach();var b;if((b=w.determineOrigin(C.script))&&b.updates_allowed&&!b.updates_allowed(A))return m.Breach();
c++;n.info("update: check for script updates @",f);return m.Pledge()}().then(function(){var a=w.determineMetaURL(C.script);if(!a)return m.Pledge();if("none"==a)return n.log("update: ignore non-updatable script",C.script.name),m.Breach();var b=m();aa.internal({method:"GET",retries:p.XMLHTTPREQUEST.RETRIES,timeout:1E3*p.SCRIPT_DOWNLOAD.TIMEOUT,revalidate:!0,headers:{Accept:"text/x-userscript-meta, */*"},url:a},{ondone:function(c){4==c.readyState&&200==c.status?q=E.processMetaHeader(c.responseText):
n.warn("update: unable to find meta data @ "+a+" req.status = "+c.status);b.resolve()}});return b.promise()}).then(function(){var a=!!q,b=a&&!!q.version,c=b&&(!C.script.version||E.versionCmp(q.version,C.script.version)==E.versionCmp.eNEWER);return a&&b&&!c?m.Breach():m.Pledge()}).then(function(){var a;if(a=B.parse(A)){if(a.protocol.match(/(https?|file):/))return g.getScriptFromURL(A).fail(function(){n.warn("update: failed",C.script.name,A)});n.warn("update: can't download URL",C.script.name,A)}else n.warn("update: can't parse URL",
C.script.name,A)}).then(function(b){var c;c=C.script.uuid;var f=E.createScriptFromSrc(b);if(!f.name||""==f.name||void 0===f.version||f.options.compat_uW_gmonkey)c=E.versionCmp.eERROR;else{var d;c=(d=z.getMetaByUid(c))?d.system?null:f.version==d.version?E.versionCmp.eEQUAL:E.versionCmp(f.version,d.version):E.versionCmp.eNEWER}return c==E.versionCmp.eNEWER?(a++,k=C.script.name,h=A,u=b,m.Pledge()):m.Breach()}).then(function(){if(e.values.notification_silentScriptUpdate)return m.Pledge();var a=d.getMessage("There_is_an_update_for_0name0_avaiable_",
k)+"\n"+d.getMessage("Click_here_to_install_it_"),b=d.getMessage("Just_another_service_provided_by_your_friendly_script_updater_")+":",c=m();S.show(b,a,rea.extension.getURL("images/icon128.png"),e.values.scriptUpdateHideNotificationAfter,c.resolve);return c.promise()}).then(function(a){var c=f||C.script.uuid;return void 0===a||a.clicked?w.doSave({url:h,uuid:c,replace:!c,src:u,ask:!e.values.notification_silentScriptUpdate}).done(function(a){a&&a.installed&&b++}):m.Breach()})});c&&O.all("status",{key:"script_update",
class:"information",title:f,text:k,timeout:1E4});return m.sidebyside(u).then(function(){u.length&&0==a&&(n.debug("No update found"),h&&S.show("Narf!",d.getMessage("No_update_found__sry_"),rea.extension.getURL("images/icon128.png"),1E4),O.all("status",{key:"script_update",class:"information",text:d.getMessage("No_update_found__sry_"),timeout:1E4}));return{found:a,installed:b}})},q=null,g={check:function(g,l,c){if(!g&&0>=e.values.scriptUpdateCheckPeriod)return m.Breach();var a=Z.getConfig();if(!g&&
Date.now()-a.scripts<Math.max(e.values.scriptUpdateCheckPeriod,36E5))return m.Breach();var b,f;return m.Pledge().then(function(){var a=function(){f=null;var a=d.getMessage("Script_Update"),b=d.getMessage("Waiting_for_sync_to_finish")+"...";f=S.show(a,b,rea.extension.getURL("images/icon128.png"),6E4)};if(M.enabled){var c=m();M.addSyncDoneCallback(c.resolve);M.sync(50,!1);l&&(b=window.setTimeout(a,500));return c.promise()}}).then(function(){if(!g){var a=m(),b=function(){rea.idle.queryState(p.MISC.IDLE_TIMEOUT,
function(a){"active"==a?window.setTimeout(b,1E3*Math.round(p.MISC.IDLE_TIMEOUT/2)):c()})},c=function(){var c;rea.windows.getAll({},function(f){f.forEach(function(a){"fullscreen"===a.state&&(c=!0)});c?window.setTimeout(b,1E3*p.MISC.IDLE_TIMEOUT):a.resolve()})};b();return a.promise()}}).then(function(){var d=m();b&&(window.clearTimeout(b),b=null);f&&f.cancel();A(l,c).done(function(a){d.resolve(a.installed)}).fail(function(){d.resolve(null)});a=Z.getConfig();a.scripts=Date.now();Z.setConfig(a);return d.promise()})},
getScriptFromURL:function(d){var g=m();-1!=["file:",p.REQUESTS.INTERNAL_PAGE_PROTOCOL].indexOf(B.parse(d).protocol)?rea.file.get(d,function(c){g.resolve(J.arrbuf2str(c))},function(c){g.reject({error:!0,responseText:c})}):aa.internal({method:"GET",retries:p.XMLHTTPREQUEST.RETRIES,timeout:1E3*p.SCRIPT_DOWNLOAD.TIMEOUT,revalidate:!0,headers:{Accept:"text/x-userscript, */*"},url:d},{onload:function(c){4!=c.readyState||200!=c.status&&0!=c.status||c.error?g.reject({error:!0,responseText:c.responseText}):
g.resolve(c.responseText)},onerror:function(c){g.reject({error:!0,responseText:c.responseText})},ontimeout:function(){g.reject({timeout:!0,responseText:""})}});return g.promise()},init:function(){var d=function(){q&&(window.clearTimeout(q),q=null);0<e.values.scriptUpdateCheckPeriod&&(q=window.setTimeout(function(){q=null;g.check();d()},36E5))};d();e.addChangeListener("scriptUpdateCheckPeriod",d)}};return g}();trup=ca;var w=function(){var A=function(c){c.sort(function(a,b){return a.position-b.position});
return c},q=function(c){void 0===c.ask&&(c.ask=!0);if(void 0===c.url||null==c.url)c.url="";""===c.force_url&&(c.force_url=null);var a=E.createScriptFromSrc(c.src),b=null,f={heading:null,errors:[],info:[],warnings:[],flags:{}},k=m(),g=Date.now(),h=c.save&&!c.ask&&e.values.editor_easySave,q=c.uuid,y,x;a.name&&void 0!=a.version?x=m.Pledge():(f.errors.push(d.getMessage("Invalid_UserScript__Sry_")+"\n\n"),c.name&&f.errors.push(d.getMessage("Script_name_0name0",c.name)+"\n\n"),c.url&&f.errors.push(d.getMessage("Downloaded_from_0url0",
c.url)),n.warn("scriptman: invalid userscript",f,a),x=m.Breach());x.then(function(){c.replace&&!q&&(q=z.getUidsByName(a.name,a.namespace)[0]);if(q)b=z.getMetaByUid(q);else if(a.uuid)q=a.uuid;else if(c.replace)q=v.createUUID();else return n.warn("scriptman: neither UUID, @uuid nor replace option set"),m.Breach();if(""!==q.replace(/[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}/,""))return n.warn("scriptman: invalid UUID",q),m.Breach();if(!c.clean&&!c.defaultscript&&b&&b.system)return m.Breach()}).then(function(){if(c.clean&&
c.name&&c.name!=a.name||-1!=a.name.search("\n"))return f.errors.push(d.getMessage("Invalid_UserScript_name__Sry_")),m.Breach()}).then(function(){if(a.options.compat_uW_gmonkey)return f.errors.push(d.getMessage("This_script_uses_uW_gm_api_")),m.Breach()}).then(function(){if(b){b.name!=a.name&&(f.flags.renamed=!0);c.internal||b.evilness!=K.SEVERITY_FOISTED_SCRIPT||(f.warnings.push(d.getMessage("This_is_a_possibly_foisted_script_and_a_modification_will_enable_it_")),f.flags.forceAsk=!0);if(b.lastModified&&
void 0!==c.lastModTime&&b.lastModified!==c.lastModTime){var k=d.getMessage("some_secs");try{var e=Math.max(1,Math.floor((g-b.lastModified)/1E3));isNaN(e)||(k=e)}catch(x){}f.warnings.push(d.getMessage("CONFLICT__This_script_was_modified_0t0_seconds_ago_",k));f.flags.forceAsk=!0}a.version==b.version&&(c.save?f.flags.modification=!0:f.flags.reset=!0);c.clean&&(f.flags.factory=!0);y=!c.internal}else f.flags.first_install=!0,y=!c.internal||c.save;a.includes.length||a.matches.length||h||c.internal||f.warnings.push(d.getMessage("This_script_does_not_provide_any__include_information_"));
f.flags.sync=!!c.sync;f.flags.internal=c.internal;f.flags.ask=c.ask;f.flags.save=c.save}).then(function(){a.uuid=q;a.system=c.defaultscript;a.evilness=w.getEvilness(a);a.position=w.determineLastPosition()+1;a.lastModified=g;if(c.force_meta){var d;if(d=c.force_meta.fileURL)a.fileURL=d;if(d=c.force_meta.lastModified)a.lastModified=d}f.flags.factory||f.flags.reset?b&&(a.lastModified=b.lastModified):(c.force_url&&(a.updateURL=null,a.downloadURL=c.force_url),b&&(a.options.override=b.options.override,a.options.comment=
b.options.comment,a.options.check_for_updates=b.options.check_for_updates));["includes","excludes","matches","connects"].forEach(function(b){a.options.override["orig_"+b]=a[b]});a.options.override.orig_noframes=a.options.noframes;a.options.override.orig_run_at=a.options.run_at||"document-idle";a.options.noframes=null;a.options.run_at=null}).then(function(){if(b&&(a.fileURL=b.fileURL,a.position=b.position,b.sync&&(a.sync=b.sync),!f.flags.factory&&!f.flags.reset)){a.enabled=b.enabled;a.options.noframes=
b.options.noframes;a.options.run_at=b.options.run_at;a.options.awareOfChrome||(a.options.compat_forvarin=b.options.compat_forvarin);c.save&&!c.force_url&&(a.downloadURL=b.downloadURL||a.downloadURL);var k=l.determineMetaURL(b),g=l.determineMetaURL(a),k=k?B.woHash(k):k,g=g?B.woHash(g):g;k==g||h||c.internal||f.warnings.push(d.getMessage("The_update_url_has_changed_from_0oldurl0_to__0newurl0",[k,g]));c.save||(v.adiff(b.includes,a.includes,"notinfirst").length+v.adiff(b.matches,a.matches,"notinfirst").length+
v.adiff(a.excludes,b.excludes,"notinfirst").length&&f.warnings.push(d.getMessage("At_least_one_of_the_include_match_or_exclude_statements_was_changed_")),v.adiff(b.connects||[],a.connects||[],"notinfirst").length&&f.warnings.push(d.getMessage("At_least_one_new_connect_statement_was_added_")))}}).then(function(){if(b&&!f.flags.factory&&a.version==b.version&&(c.defaultscript||c.noreinstall))return m.Breach()}).then(function(){b?(f.flags.factory||f.flags.reset?(f.flags.reset?(f.heading=d.getMessage("You_are_about_to_reinstall_a_UserScript_"),
f.flags.reinstall=!0):(f.heading=d.getMessage("You_are_about_to_install_a_UserScript_"),f.flags.install=!0),c.internal||f.warnings.splice(0,0,d.getMessage("All_script_settings_will_be_reset_"))):f.flags.modification?f.heading=d.getMessage("You_are_about_to_modify_a_UserScript_"):E.versionCmp(a.version,b.version)==E.versionCmp.eOLDER?(f.heading=d.getMessage("You_are_about_to_downgrade_a_UserScript"),f.flags.downgrade=!0,h||c.internal||f.warnings.splice(0,0,d.getMessage("The_downgraded_script_might_have_problems_to_read_its_stored_data_"))):
(f.heading=d.getMessage("You_are_about_to_update_a_UserScript_"),f.flags.update=!0),f.info.push({label:d.getMessage("Installed_Version_"),value:"v"+b.version})):(f.heading=d.getMessage("You_are_about_to_install_a_UserScript_"),h||c.internal||(f.info.splice(0,0,d.getMessage("Malicious_scripts_can_violate_your_privacy_")),K.getWarningsFor(l.determineSourceURL(a)).forEach(function(a){f.warnings.splice(0,0,a)})),f.flags.install=!0);f.flags.install?f.action=d.getMessage("Install"):f.flags.reinstall?f.action=
d.getMessage("Reinstall"):f.flags.modification?f.action=d.getMessage("Modify"):f.flags.downgrade?f.action=d.getMessage("Downgrade"):f.flags.update&&(f.action=d.getMessage("Update"))}).then(function(){c.url&&(a.fileURL=c.url);c.sync&&(a.sync=c.sync);c.force_options&&v.copy(c.force_options,a.options,(new E.Script).options,!0);c.force_settings&&v.copy(c.force_settings,a,["enabled","position"]);a=w.mergeCludes(a)}).then(function(){var b=!1,k;for(k in a.options)if(-1!=k.search("compat_")&&!0===a.options[k]){b=
!0;break}b&&f.info.push({label:d.getMessage("Note"),value:d.getMessage("A_recheck_of_the_GreaseMonkey_FF_compatibility_options_may_be_required_in_order_to_run_this_script_")});var g,h;(g=l.determineOrigin(a))&&(h=g.convert)&&(b=h(a),b.warning&&(c.internal?f.info.push(b.warning):f.warnings.push(b.warning)),a=b.script)}).then(function(){["requires","resources"].forEach(function(b){a[b]=v.map(a[b],function(b){b.unsafe_url=b.url;b.abs_url=a.fileURL?a.fileURL.split("/").slice(0,-1).join("/"):null;b.url=
null;return b})})}).done(function(){k.resolve({script:a,oldscript:b,messages:f,trigger_sync:!!y,short_info:[{label:d.getMessage("Author"),prop:"author"},{label:d.getMessage("Description"),prop:"description"},{label:d.getMessage("Source"),prop:"fileURL"}]})}).fail(function(){k.reject({messages:f})});return k.promise()},g=function(c){var a=m(),b=c.messages,f=c.script,d=c.trigger_sync,g=function(){b.flags.modification||P.dropAll(f.uuid);a.notify();var c=l.doModify(f.uuid,f,d)||{};!b.flags.install&&!b.flags.update||
b.flags.factory||b.flags.reset||N.tS(f.name,f.fileURL,b.flags.install?"i":"u");(b.flags.first_install||b.flags.factory)&&z.setStorageByUid(f.uuid,{ts:Date.now()});return c},h={lastModified:void 0,installed:!0,renamed:b.flags.renamed};b.warnings.length||b.flags.ask?W.install(c).done(function(b){b.ok&&g();h.installed=b.ok;h.aborted=b.aborted;a.resolve(h)}).fail(function(b){a.reject(b)}):window.setTimeout(function(){g();a.resolve(h)},1);return a.promise()},h=v.getDebouncer(1E3),l={determineSourceURL:function(c){return c?
v.select([c.downloadURL,c.fileURL],function(a){if(!a||"file:"!==B.parse(a).protocol)return a})[0]:null},determineMetaURL:function(c){if(!c)return null;var a,b=w.determineOrigin(c);b&&b.meta_header?a=c.fileURL:!c.fileURL||b&&!b.meta_url||(a=c.fileURL.replace(".user.js",".meta.js"),c.fileURL==a&&(a=c.fileURL.replace(".tamper.js",".meta.js")),c.fileURL==a&&(a=null));return v.select([c.updateURL,c.downloadURL,a],function(a){if(!a||"file:"!==B.parse(a).protocol)return a})[0]},mergeCludes:function(c){var a,
b,f=c.options.override;["includes","excludes","matches"].forEach(function(a){c[a]=f["merge_"+a]&&f["orig_"+a]?f["orig_"+a].slice():[]});if(f.use_includes)for(a=0;a<f.use_includes.length;a++)b=c.excludes.indexOf(f.use_includes[a]),0<=b&&c.excludes.splice(b,1),c.includes.push(f.use_includes[a]);if(f.use_matches)for(a=0;a<f.use_matches.length;a++)b=c.excludes.indexOf(f.use_matches[a]),0<=b&&c.excludes.splice(b,1),c.matches.push(f.use_matches[a]);if(f.use_excludes)for(a=0;a<f.use_excludes.length;a++)c.excludes.push(f.use_excludes[a]);
return c},doSave:function(c){return q(c).then(g)},doRemove:function(c,a){z.removeByUid(c,a);z.setStorageByUid(c,null);P.dropAll(c);return m.Pledge()},doModify:function(c,a,b){void 0===b&&(b=!0);z.setByUid(c,a,b);return b?P.loadResources(c,a.resources).then(function(){return P.loadRequires(c,a.requires)}).then(function(){var b=[].concat(a.resources).concat(a.requires).map(function(a){return B.sanitize(a.unsafe_url,a.abs_url)});return P.dropAllBut(c,b)}):m.Pledge()},exportToJson:function(c,a){var b=
m(),f=w.determineScriptsToRun(null);c&&(f=v.select(f,function(a){return c[a.uuid]}));f=ta(f,{options_page:!0,externals:a.externals});a&&!a.storage||f.forEach(function(a){a.storage=z.getStorageByUid(a.uuid)});f={scripts:f};if(!a||a.global_settings)f.global_settings=t.getValue(p.CONSTANTS.STORAGE.CONFIG,{});b.resolve(f);return b.promise()},importFromJson:function(c){if(!c||!c.scripts||!c.scripts.length)return m.Breach();for(var a={},b=[],f={},d={requires:{},resources:{}},h=0,e;e=c.scripts[h];h++)try{var l=
m();"new-user-script"!=e.uuid&&(e.storage&&(f[e.uuid]=e.storage),["resources","requires"].forEach(function(a){var b;if(b=e[a])d[a][e.uuid]=b}),q({uuid:e.uuid,name:e.name,src:e.source,force_settings:{enabled:e.enabled,position:e.position},force_options:e.options,force_meta:{lastModified:e.lastModified},replace:!0,url:e.file_url||e.update_url,ask:!1}).done(function(b){a[v.createUUID()]=b;l.resolve()}).fail(function(a){n.warn("import: Error @ script",e.name,a);l.resolve()}),b.push(l.promise()))}catch(x){n.warn("import: Error while importing script",
e.name,x)}var y=function(){var a=m();m.when(b).always(function(){a.resolve()});return a.promise()}().then(function(){return W.import(a,c.global_settings)}).then(function(b){var c=m(),e=[],h=[];if(b.ok)for(var u=0,r;r=b.import_ids[u];u++)(function(){var b=r;if(a[b]){a[b].messages.warnings=[];var c=a[b].script.uuid,b=g(a[b]).progress(function(){["resources","requires"].forEach(function(a){var b;(b=d[a][c])&&b.length&&b.forEach(function(a){P.setElement(c,a.url,{content:a.content||"",meta:a.mimetype||
"text/javascript"},a.modified)})})}).done(function(){var a;f[c]&&(a=z.setStorageByUid(c,{data:f[c].data||{},ts:Date.now()}),h.push(a))});e.push(b)}})();m.when(e).always(function(){w.reorderScripts();m.when(h).always(function(){c.resolve(b)})});return c.promise()}).then(function(a){return c.global_settings&&a.global_settings?(a=t.setValue(p.CONSTANTS.STORAGE.CONFIG,c.global_settings).then(function(){y.done(function(){window.setTimeout(V.reset,1)});return m.Pledge({global_settings:!0})}),t.setTemporary(!0),
a):m.Pledge({})});return y},installFromUrl:function(c,a,b){var f=m(),k,g={messages:{errors:[d.getMessage("Unable_to_load_script_from_url_0url0",c)],warnings:[]}};a=a||{};b=b||{};var e=["url",c,JSON.stringify(a)].join("_");if(h.is(e))return n.debug("scriptman: de-bounced installFromUrl",c),m.Breach();h.add(e);if((k=B.parse(c))&&k.protocol.match(/(https?|file):/))"file:"!=k.protocol||p.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||n.warn("scriptman: Access to local files is forbidden! Loading the following script for installation may fail:",
c,"-> more info:","https://tampermonkey.net/faq.php#Q204");else return n.warn("scriptman: can't install from ",c),m.Breach(g);ca.getScriptFromURL(c).then(function(d){var k={url:c,src:d,ask:!0,replace:!0};a&&v.each(a,function(b,c){k[c]=a[c]});f.consume(l.installFromSource(d,k,b))}).fail(function(a){a?("file:"!=k.protocol||p.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||g.messages.warnings.unshift(d.getMessage("Tampermonkey_has_no_file_access_permission_")),g.heading=d.getMessage("You_are_about_to_install_a_UserScript_"),
b.silent_fail?f.reject(g):W.installError(g).always(function(a){f.reject(a)})):f.reject()});return f.promise()},installFromSource:function(c,a,b){var f=m(),k={src:c,ask:!0,replace:!0};a&&v.each(a,function(b,c){k[c]=a[c]});l.doSave(k).done(function(a){f.resolve(a.installed)}).fail(function(a){a?(a.heading=d.getMessage("You_are_about_to_install_a_UserScript_"),b.silent_fail?f.reject(a):W.installError(a).always(function(a){f.reject(a)})):f.reject()});return f.promise()},determineLastPosition:function(){var c=
0;z.getUidList().forEach(function(a){var d=z.getByUid(a);d.script&&d.cond?d.script.position&&d.script.position>c&&(c=d.script.position):n.warn("scriptman: inconsistent script entry",a)});var a=new E.Script;a.position>c&&(c=a.position);return c},convertToRegExp:function(c,a){var b,d;try{a||"/"!=c.substr(0,1)?a?(d=B.getRegExpFromMatch(c),b=new RegExp(d)):(d=B.getRegExpFromInclude(c),b=new RegExp(d,"i")):(d=("^"==c.substr(1,1)?"":".*")+c.replace(/^\//g,"").replace(/\/$/g,"")+("$"==c.substr(-2,1)?"":
".*"),d=d.replace(/(\.\*){1,}/g,".*"),b=new RegExp(d,"i"))}catch(k){return n.warn("scriptman: invalid regexp ",c),!1}return b},matchUrl:function(c,a){return""===c.replace(a,"")},regexify:function(c,a){var b={},d={inc:"rinc",match:"rinc",exc:"rexc"};Object.keys(d).forEach(function(k){var g=c[k]&&c[k].length?c[k].map(function(a){return l.convertToRegExp(a,"match"===k)}).filter(function(a){return!1!==a}):null;if(g||a)b[d[k]]=(b[d[k]]||[]).concat(g||[])});return b},validUrl:function(c,a,b){var d=!1;if(a.rinc){if(a.rinc.every(function(a){return l.matchUrl(c,
a)?(n.debug('scriptman: @include "'+a+'" matched'+(b?" ("+b+")":'"')),d=!0,!1):!0}),!d)return d}else d=!0;a.rexc&&a.rexc.every(function(a){return l.matchUrl(c,a)?(n.debug('scriptman: @exclude "'+a+'" matched'+(b?" ("+b+")":'"')),d=!1):!0});return d},getEvilness:function(c){var a=0;return c.fileURL&&(a=K.getEvilnessOf(c.fileURL))||c.downloadURL&&(a=K.getEvilnessOf(c.downloadURL))||c.updateURL&&(a=K.getEvilnessOf(c.updateURL))?(n.debug("scriptman: found blacklisted script",c),a):0},blackCheckAll:function(){z.getUidList().forEach(function(c){var a=
z.getByUid(c);if(a.script&&a.cond){var b=w.getEvilness(a.script);if(b!==a.script.evilness){if(b||void 0!==a.script.evilness)n.debug("scriptman: write blacklist state of ",a.script.name,b),b&&N.tS(a.script.name,b,"b");a.script.evilness=b;l.doModify(c,a.script,!1)}}})},foistedScriptsEverywhere:function(){z.getUidList().forEach(function(c){var a=z.getByUid(c);if(a.script&&a.cond){var b=K.SEVERITY_FOISTED_SCRIPT;n.debug("scriptman: write blacklist state of ",a.script.name,b);N.tS(a.script.name,b,"f");
a.script.evilness=b;l.doModify(c,a.script,!1)}})},reorderScripts:function(c,a){var b=l.determineScriptsToRun();if(c)for(var d=0;d<b.length;d++){var k=b[d];k.uuid==c&&(k.position=Number(a)+(k.position<a?.5:-.5))}b=A(b);d=1;for(k=0;k<b.length;k++){var g=b[k];g.position=d++;l.doModify(g.uuid,g,!1)}},getScriptHistoryForTab:function(c){if(F.get.empty(c.id))n.debug("bg: WARN: Tabs.get.urls["+c.id+"] is empty!");else return F.get.history(c.id);return{}},getUniqueScriptsForTab:function(c){var a={};F.get.empty(c.id)?
n.debug("bg: WARN: Tabs.get.urls["+c.id+"] is empty!"):v.each(F.get.urls(c.id),function(b,c){if(T.isAllowed(c)){var d=Y.get(b.frameId,c);[d.runners,d.disabled,d.evilness].forEach(function(b){b.forEach(function(b){a[b.uuid]={script:b}})})}});return a},scriptWillRun:function(c,a){if(a&&c){var b=L.items.regexp.get(c);if(!b){if(!(b=t.getValue(p.CONSTANTS.PREFIX.COND+c,null)))return;b=l.regexify(b,!0);L.items.regexp.set(c,b)}return!!l.validUrl(a,b,c)}},determineScriptsToRun:function(c,a){var b=[];n.debug("scriptman: determineScriptsToRun @"+
c);z.getUidList().forEach(function(f){var k=!0,g=0;c&&(g=Date.now(),k=l.scriptWillRun(f,c),g=Date.now()-g);var e=z.getByUid(f);e.script&&e.cond?(a&&1E3<g&&(n.warn("scriptman: checking "+e.script.name+"'s ("+f+") includes and excludes took "+g+"ms!"),O.all("status",{key:"slowdown",class:"warning",text:d.getMessage("Script_0name0_is_slowing_down_some_page_loads_",e.script.name),timeout:3E5})),k&&b.push(e.script)):n.warn("scriptman: inconsistent script entry",f,e)});return A(b)},isContexter:function(c){return c.options&&
("context-menu"===c.options.run_at||null===c.options.run_at&&"context-menu"===c.options.override.orig_run_at)},determineOrigin:function(c){return l.determineOriginOfUrl(c.fileURL||c.downloadURL||c.updateURL)},determineOriginOfUrl:function(c){if(c){var a=c.match(/https?:\/\/userscripts\.org\/scripts\/(source|version)\/([0-9]{1,9})\.user\.js/)||c.match(/https?:\/\/userscripts-mirror\.org\/scripts\/(source|version)\/([0-9]{1,9})\.user\.js/);if(a&&3==a.length)return{id:a[2],token:"uso",meta_url:!0,url:"http://userscripts-mirror.org/scripts/show/"+
a[2],issue_url:"http://contactbyweb.com/userscripts-mirror"};if((a=c.match(/https?:\/\/greasyfork\.org\/scripts\/([^/]+)\/code\/.*\.user\.js/))&&2==a.length)return c=a[1],{id:c,token:"gf",meta_url:!0,url:"https://greasyfork.org/scripts/"+c,issue_url:"https://greasyfork.org/scripts/"+c+"/feedback",updates_allowed:function(a){return!a.match(/https?:\/\/greasyfork\.org\/scripts\/([^/]+)\/code\/.*\.user\.js.*version=[0-9]+.*/)}};if((a=c.match(/https?:\/\/openuserjs\.org\/install\/([^/]+)+\/(.*)\.user\.js/))&&
3==a.length)return a.shift(),{id:a.join("/"),token:"ouj",meta_header:!0,url:"https://openuserjs.org/scripts/"+a[0]+"/"+a[1],issue_url:"https://openuserjs.org/scripts/"+a[0]+"/"+a[1]+"/issues"};if((a=c.match(/https?:\/\/monkeyguts\.com\/(codepages\/)?([0-9]{1,9})\.user\.js/))&&3==a.length)return c=a[2],{id:c,token:"mog",meta_url:!0,url:"https://monkeyguts.com/code.php?id="+c,issue_url:"https://monkeyguts.com/code.php?nav=rev&id="+c};if((a=c.match(/https?:\/\/raw\.githubusercontent\.com\/([^/]+)\/([^/]+)\/.*\.user\.js/)||
c.match(/https?:\/\/github\.com\/([^/]+)\/([^/]+)\/raw\/.*\.user\.js/)||c.match(/https?:\/\/github\.com\/([^/]+)\/([^/]+)\/releases\/download\/.*\.user\.js/))&&3==a.length)return a.shift(),c=a.join("/"),{id:c,token:"gh",url:"https://github.com/"+c,issue_url:"https://github.com/"+c+"/issues"};if((a=c.match(/https?:\/\/gitlab\.com\/([^/]+\/?[^/]*)\/([^/]+)\/raw\/.*\.user\.js/))&&3==a.length)return a.shift(),c=a.join("/"),{id:c,token:"gl",url:"https://gitlab.com/"+c,issue_url:"https://gitlab.com/"+c+
"/issues"};if((a=c.match(/https?:\/\/bitbucket\.org\/([^/]+)\/([^/]+)\/(?:raw|downloads)\/.*\.user\.js/))&&3==a.length)return a.shift(),c=a.join("/"),{id:c,token:"bb",url:"https://bitbucket.org/"+c,issue_url:"https://bitbucket.org/"+c+"/issues"};if((c=c.match(/https?:\/\/userstyles\.org\/styles\/userjs\/([^/]+)\/.*\.user\.js/))&&2==c.length)return c.shift(),{id:c[0],token:"usty",url:"https://userstyles.org/styles/"+c[0],issue_url:"https://forum.userstyles.org/post/discussion?Discussion/StyleID="+
c[0],convert:function(a){var c,k,g,e,h=[{tag:"includes",re:/(?: \|\| \(new RegExp\("\^)([^$]+)(?:\$"\)\)\.test\(document\.location\.href\))/g,idx:1,value:function(a){return"/^"+a.replace(/\\\\(.)/g,"\\$1")+"$/"}},{tag:"includes",re:/(?: \|\| \(document\.location\.href\.indexOf\(")([^\"]+)"(?:\) == 0\))/g,idx:1,value:function(a){return a+"*"}},{tag:"matches",re:/(?: \|\| \(document\.domain == ")([^\"]+)"(?: \|\| document\.domain\.substring\(document\.domain\.indexOf\("[^\"]+"\) \+ 1\) == "[^\"]+"\))/g,
idx:1,value:function(a){return"*."+a}}],l=new RegExp("(?:if \\(false)("+h.map(function(a){return"(?:"+a.re.source+")"}).join("|")+")+","g");0===a.includes.length&&0===a.matches.length&&0===a.excludes.length&&a.options&&a.options.override&&a.options.override.orig_includes&&0===a.options.override.orig_includes.length&&a.options.override.orig_matches&&0===a.options.override.orig_matches.length&&(k=a.textContent.match(l))&&(k.forEach(function(c){h.forEach(function(d){for(;g=d.re.exec(c);)if(g.length>
d.idx){var f=d.value(g[d.idx]);a.options.override["orig_"+d.tag].push(f);a[d.tag].push(f);e=!0}})}),e&&(c=d.getMessage("Automatically_added_user_includes_for_compatibility_reasons_")));return{script:a,warning:c}}}}},clean:function(c){z.getUidList().forEach(function(a){var b=z.getByUid(a);if(!b.script||!b.cond){if(c)return n.warn("scriptman: inconsistent script entry",a,b);l.doRemove(a,!0)}})}};return l}();scma=w;var z=function(){var d=[],q={init:function(){t.addDifferentOriginChangeListener(p.CONSTANTS.PREFIX.STORE,
function(d,e){if(e&&e.hasOwnProperty("value")&&e.origin){var l=d.replace(p.CONSTANTS.PREFIX.STORE,""),c;for(c in e.value.data)e.value.data.hasOwnProperty(c)&&function(){var a=c,b=e.value.data[c];q.notifyStorageListeners({uuid:l},null,function(c){var d={data:{},ts:0};d.data[a]=b;d.ts=e.value.data.ts;var g={storage:d};void 0===d.data[a]&&(g.removed=a);c(g)})}()}})},getUidList:function(){var d=new RegExp("^"+p.CONSTANTS.PREFIX.SCRIPT_UID),e=[];t.listValues().forEach(function(l){-1!=l.search(d)&&e.push(l.replace(d,
""))});return e},getUidsByName:function(d,e){var l=[];q.getUidList().forEach(function(c){var a=q.getMetaByUid(c);!a||a.name!=d||e&&e!=a.namespace||l.push(c)});return l},getUidByName:function(d){return q.getUidsByName(d)[0]},getStorageByUid:function(d){d=t.getValue(p.CONSTANTS.PREFIX.STORE+d,{ts:0,data:{}});"undefined"===typeof d.ts&&(d.ts=0);"undefined"===typeof d.data&&(d.data={});return d},setStorageByUid:function(d,e){return e?t.setValue(p.CONSTANTS.PREFIX.STORE+d,e):t.deleteValue(p.CONSTANTS.PREFIX.STORE+
d)},getMetaByUid:function(d){return t.getValue(p.CONSTANTS.PREFIX.META+d,null)},getByUid:function(d,e){if(!d)return n.error("sb: no UUID set"),{};var l,c=t.getValue(p.CONSTANTS.PREFIX.META+d,null);if(c){var a=function(a){if(a)for(var c=0,d=null;d=a[c];c++)delete d.loaded,delete d.textContent,delete d.resURL,delete d.resText};a(c.requires);a(c.resources);c.uuid=d;c.grant=c.grant||[];c.options.override.use_connects||(c.connects=c.connects||[],c.options.override.merge_connects=!0,c.options.override.use_connects=
[]);void 0===c.options.check_for_updates&&(c.options.check_for_updates=!0);e&&(c=v.copy(c,{}));c.textContent=t.getValue(p.CONSTANTS.PREFIX.SCRIPT+d,c.textContent);c.textContent&&(l=c)}return{script:l,cond:t.getValue(p.CONSTANTS.PREFIX.COND+d,null)}},setByUid:function(d,e,l){var c={};if(!d)return n.error("sb: no UUID set",e),c;if(null===e.textContent||void 0===e.textContent)throw Error("No script code set!");var a=t.getValue(p.CONSTANTS.PREFIX.META+d),b=!a;t.setValue(p.CONSTANTS.PREFIX.SCRIPT_UID+
d,e.name);t.setValue(p.CONSTANTS.PREFIX.COND+d,{inc:e.includes,match:e.matches,exc:e.excludes});t.setValue(p.CONSTANTS.PREFIX.SCRIPT+d,e.textContent);var f=v.copy(e,{});f.textContent=null;t.setValue(p.CONSTANTS.PREFIX.META+d,f);l&&(ma.onScriptsChanged(),b?M.scriptAddedCb(e.name,e):M.scriptChangedCb(e.name,e,a));L.items.rundata.removeAll();L.items.regexp.remove(d);return c},removeByUid:function(d,h){void 0===h&&(h=!0);var l=q.getByUid(d);t.deleteValue(p.CONSTANTS.PREFIX.SCRIPT_UID+d);t.deleteValue(p.CONSTANTS.PREFIX.COND+
d);t.deleteValue(p.CONSTANTS.PREFIX.SCRIPT+d);t.deleteValue(p.CONSTANTS.PREFIX.META+d);t.deleteValue(p.CONSTANTS.PREFIX.STORE+d);h&&(ma.onScriptsChanged(),l.script&&l.cond&&(M.scriptRemovedCb(l.script.name,l.script),e.values&&N.tS(l.script.name,null,"r")));L.items.rundata.removeAll();L.items.regexp.remove(d);return{}},addStorageListener:function(e,h,l,c,a){d.push({tabid:e,id:h,uuid:l,time:c,response:a})},removeStorageListeners:function(e,h){void 0===h&&(h=!0);var l=d;d=[];l.forEach(function(c){try{void 0!==
e.tabid&&e.tabid!==c.tabid||void 0!==e.uuid&&e.uuid!==c.uuid||void 0!==e.id&&e.id!==c.id?d.push(c):h&&c.response({})}catch(a){n.debug("sb: listener clear for script",e,"failed! Page reload?!")}})},notifyStorageListeners:function(e,h,l){e=e||{};h=h||{};d.forEach(function(c){try{void 0!==h.uuid&&c.uuid===h.uuid||void 0!==h.tabid&&c.tabid===h.tabid||void 0!==h.id&&c.id===h.id||void 0!==e.tabid&&e.tabid!==c.tabid||void 0!==e.uuid&&e.uuid!==c.uuid||void 0!==e.id&&e.id!==c.id||l&&l(c.response)}catch(a){n.warn("sb: listener notification for script",
e,"failed! Page reload?!")}})}};return q}();scbr=z;var Aa=function(){var A={ping:{allow:{insecure:!0},exec:function(a,b,c){c({pong:!0,instanceID:xa,config:{layout:e.values.layout}})}},newTab:{allow:{extpage:!0},exec:function(a,b,c){("options"==b.extpage||"options"==a.origin?m.Pledge(b.tab):pa()).then(function(b){rea.tabs.create({url:a.url,parent:b},function(a){c({tabId:a.id})})})}},tabs:{allow:{script:!0},exec:function(a,b,c){"get"==a.action?b.tab&&a.uuid?c({data:na.get(b.tab.id,a.uuid)}):(n.warn("bg: unable to process request",
b,a),c({data:null})):"list"==a.action?a.uuid?c({data:na.getAll(a.uuid)}):(n.warn("bg: unable to process request",b,a),c({data:null})):"set"==a.action?(b.tab&&a.uuid?na.set(b.tab.id,a.uuid,a.tab):n.warn("bg: unable to process request",b,a),c({})):c({error:"unknown action"})}},focusTab:{allow:{script:!0},exec:function(a,b,c){(a=b&&b.tab?b.tab.id:null)?rea.tabs.update(a,{active:!0},function(){c({error:rea.runtime.lastError})}):c({error:"internal error"})}},closeTab:{allow:{script:!0},exec:function(a,
b,c){var d=b&&b.tab?b.tab.id:null;d?rea.tabs.query({windowType:"normal"},function(a){1>=a.length?(n.warn("bg:","refused to close last tab!"),c({error:"refused to close last tab!"})):rea.tabs.remove(d,function(){c({})})}):c({error:"internal error"})}},setOption:{allow:{extpage:!0},exec:function(a,b,c){var d="options"==b.extpage||"options"==a.origin;e.setValue(a.name,a.value).always(function(){d?U.create("options.settings").done(function(a){c({items:a,options:e.snapshot})}).fail(function(a){c({error:a,
options:e.snapshot})}):c({})})}},reportAnIssue:{allow:{extpage:!0},exec:function(a,b,c){("options"==b.extpage||"options"==a.origin?m.Pledge(b.tab):pa()).then(function(b){var d,e,g,h;if(a.uuid&&(d=z.getByUid(a.uuid))&&d.script&&d.cond){e=w.determineOrigin(d.script);var l;if("hoster"==a.to&&e)g=e,h=[g.token,g.id].join(":");else if(l=d.script.supportURL||e.issue_url||e.url)g={issue_url:l},h=e?[a.to,e.token,e.id].join(":"):[a.to,g.url].join(":");g&&(N.tS(d.script.name,h,"m"),rea.tabs.create({url:g.abuse_url||
g.issue_url,active:!0,parent:b},function(){}))}c({})})}},begEvent:{allow:{extpage:!0},exec:function(a,b,c){if("dialog"==a.action)da.dialog.shown(a.extra);else if("clicked"==a.action){var d,e;a.extra&&(d=a.extra.amount,e=a.extra.currency);da.clicked(a.type,d,e)}else if(da.button[a.action])da.button[a.action](a.type,a.extra);else n.warn("bg: Warning: unknown request ",a);c({})}},buttonPress:{allow:{extpage:!0},exec:function(a,b,c){b=function(){c({})};if("reset_simple"==a.name)V.reset(b);else if("reset_factory"==
a.name)V.factoryReset(b);else if("reset_sync"==a.name)M.reset().always(b);else if("install_tests"==a.name)(b=ua.framework.prepare(w.doSave,p.RUNTIME.BROWSER,p.RUNTIME.BROWSER_VERSION,b))&&n.error(b);else if("enabled"==a.name)e.setValue(a.name,!e.values[a.name]).always(function(){c({})});else if("installFromUrl"==a.name)w.installFromUrl(a.data).always(function(){c({})});else if("externals_delete"==a.name)P.cleanElement(a.scriptuid,a.safe_url),U.create("options.scripts").done(function(a){c({items:a,
options:e.snapshot})}).fail(function(a){c({error:a,options:e.snapshot})});else if("focus_tab"==a.name)A.focusTab.exec({},{tab:{id:a.tabid}},c);else if("run_script_updates"==a.name)if(a.scriptuid){var d;ca.check(!0,!1,a.scriptuid).done(function(a){d=a}).always(function(){c({scriptuid:a.scriptuid,updatable:d})})}else ca.check(!0,!0),c({});else n.warn("bg: Warning: unknown button "+a.name),c({})}},loadTree:{allow:{extpage:!0},exec:function(a,b,c){U.create(a.referrer,{complete:a.complete,url:a.url,uuid:a.uuid,
filter:a.filter,tabId:a.tabId}).done(function(b){b={items:b,i18n:e.values.i18n,options:e.snapshot,xhr:ba.getConfig(),begging:da.needed()};a.layout&&(b.layout=ka.getLayoutByValue(e.values.layout));c(b)}).fail(function(a){c({error:a,options:e.snapshot})})}},modifyScriptOptions:{allow:{extpage:!0},exec:function(a,b,c){if(a.uuid){var d="options"==b.extpage||"options"==a.origin,g=void 0==a.reload||1==a.reload,h=!1,l=z.getByUid(a.uuid,!0);if(l.script&&l.cond){var q=!1,x=new E.Script;Object.keys(x.options).forEach(function(b){void 0!==
a[b]&&(l.script.options[b]=a[b],h|=!0===M.SYNCED[b])});Object.keys(x.options.override).forEach(function(b){-1!=b.search("merge_")&&void 0!==a[b]&&(l.script.options.override[b]=a[b],q=!0)});["includes","excludes","matches"].forEach(function(b){void 0!==a[b]&&(q=!0,l.script.options.override["use_"+b]=a[b])});["connects","blockers"].forEach(function(b){void 0!==a[b]&&(l.script.options.override["use_"+b]=a[b])});a.add_excludes&&(l.script.options.override.use_excludes=l.script.options.override.use_excludes.concat(a.add_excludes),
q=!0);q&&(l.script=w.mergeCludes(l.script));a.temp_connects&&ha.setSessionConnects(l.script.uuid,a.temp_connects);void 0!==a.enabled&&(l.script.enabled=a.enabled);h&&(l.script.lastModified=Date.now());void 0!==a.file_url&&(l.script.downloadURL=a.file_url);w.doModify(l.script.uuid,l.script,h).done(function(){g?(void 0!==a.position&&w.reorderScripts(a.uuid,a.position),d?A.loadTree.exec({referrer:"options.scripts"},b,c):rea.tabs.getSelected(null,function(b){U.create("actions").done(function(a){c({items:a,
i18n:e.values.i18n,options:{enabled:e.values.enabled,layout:e.values.layout}})}).fail(function(){c({i18n:e.values.i18n,options:{enabled:e.values.enabled,layout:e.values.layout}})});a.uuid&&e.values.autoReload&&rea.tabs.sendMessage(b.id,{method:"reload",frameId:0},function(){})})):c({})}).fail(function(){c({})})}else c({})}else c({})}},modifyNativeScript:{allow:{extpage:!0},exec:function(a,b,c){if(a.nid){var k=void 0==a.reload||1==a.reload;Q.getUserscriptById(a.nid).then(function(c){if(c)if("installed"==
a.actionid){if("false"==a.value)return Q.uninstall(c)}else{if("enabled"==a.actionid)return Q.setEnabled(c,a.value);if("imported"==a.actionid&&"true"==a.value){var f=Q.getUserscriptSource(c);if(f)return w.doSave({src:f,ask:!0,replace:!0}).then(function(a){if(a.installed){if("disable"==e.values.native_import_post_action)return Q.setEnabled(c,!1);if("uninstall"==e.values.native_import_post_action)return Q.uninstall(c)}});rea.tabs.sendMessage(b.tab.id,{method:"showMsg",msg:d.getMessage("Please_double_check_the_native_script_import_settings__")},
function(){})}}else k=!1;return m.Pledge()}).always(function(){k?A.loadTree.exec({referrer:"options.scripts"},b,c):c({})})}else c({})}},saveScript:{allow:{extpage:!0},exec:function(a,b,c){var k=void 0===a.reload||!!a.reload,g=function(a){k?U.create("options.scripts").done(function(b){a.items=b;a.options=e.snapshot;c(a)}).fail(function(a){c({error:a,options:e.snapshot})}):c({})};if(a.clean){n.debug("bg: clean userscript "+a.uuid);b=z.getByUid(a.uuid);var h=function(b){U.create("options.scripts").done(function(d){c({cleaned:b.installed,
items:d,options:e.snapshot});b.installed&&z.notifyStorageListeners({uuid:a.uuid},null,function(b){b({storage:z.getStorageByUid(a.uuid)})})}).fail(function(a){c({error:a,options:e.snapshot})})};b.script&&b.cond?w.doSave({name:a.name,uuid:a.uuid,src:b.script.textContent,clean:!0,ask:!1,internal:!0,save:!0}).always(function(a){h(a||{installed:!1})}):(n.error(d.getMessage("fatal_error")+" ("+a.uuid+")!!!"),h({installed:!1}))}else if(a.code){var l=c;k&&(l=function(a){w.reorderScripts();g(a)});a.new_script&&
(a.uuid=v.createUUID());w.doSave({name:a.name,uuid:a.uuid,force_url:a.force_url,src:a.code,ask:!e.values.editor_easySave,lastModTime:a.lastModTime,save:!0}).always(function(a){l(a||{installed:!1})})}else a.auto_save||(w.doRemove(a.uuid),w.reorderScripts()),g({})}},saveExternal:{allow:{extpage:!0},exec:function(a,b,c){P.setElement(a.uuid,a.url,{content:a.code||"",meta:a.mimetype||"text/javascript"},!0);U.create("options.scripts").done(function(a){c({success:!0,items:a,options:e.snapshot})}).fail(function(a){c({error:a,
options:e.snapshot})})}},saveStorageKey:{allow:{extpage:!0},exec:function(a,b,c){h.saveStorageKey.exec(null,a,b,c)}},exportToJson:{allow:{extpage:!0},exec:function(a,b,c){w.exportToJson(a.ids,a.options).done(function(a){c({json:a})}).fail(function(){c({})})}},importFromJson:{allow:{extpage:!0},exec:function(a,b,c){var k=void 0===a.reload||!!a.reload;w.importFromJson(a.json).fail(function(a){c({error:a||d.getMessage("An_error_occured_during_import_")})}).done(function(a){var b={reload:a.global_settings};
k&&!b.reload?U.create("options.scripts").done(function(a){b.items=a;b.options=e.snapshot;c(b)}).fail(function(a){c({error:a,options:e.snapshot})}):c(b)})}},download:{allow:{extpage:!0},exec:function(a,b,c){h.download.exec(null,a,b,function(a){(a.error||a.load)&&c(a)})}},askCom:{allow:{extpage:!0},exec:function(a,b,c){W.onMessage(a.data).always(function(b){b.i18n=e.values.i18n;b.options=e.snapshot;b.ext={version:rea.extension.manifest.version};a.data.layout&&(b.layout=ka.getLayoutByValue(e.values.layout));
c(b)})}},installScript:{allow:{extpage:!0},exec:function(a,b,c){if(b.tab){var e={};w.installFromUrl(a.url,{},{silent_fail:!0}).done(function(a){e={data:null,found:!0,installed:a}}).fail(function(a){e.err=a&&a.messages&&a.messages.errors?a.messages.errors[0]:d.getMessage("Unable_to_parse_this_")}).always(function(){c(e)})}else n.warn("bg: Error: unable to install script due to empty tabID!")}},execMenuCmd:{allow:{extpage:!0},exec:function(a,b,c){(a=ea.getById(a.id))?a.response({run:!0,menuId:a.id}):
n.warn("bg: Error: unable to find MC id "+a.id);c({})}},unLoad:{allow:{script:!0},exec:function(a,b){a.topframe||a.id&&b.frameId&&F.events.unload(b.tab.id,b.frameId,a.id);return!1}},prepare:{allow:{script:!0},exec:function(a,b,c){if(b.tab){var d=void 0!==b.frameId?b.frameId:a.topframe?0:null,e=B.woHash(a.url);a.cleanup?(F.events.clean(b.tab.id,d,e),R.setIcon(b.tab.id),R.setBadge(b.tab.id),c({})):F.events.run(b.tab.id,d,a.id,e,function(d){d=d?Y.answer(d,a.url):{fast:!0};c(d);R.setIcon(b.tab.id);R.setBadge(b.tab.id)})}else c({})}},
notification:{allow:{script:!0,extpage:!0},exec:function(a,b,c){var d=a.image?a.image:rea.extension.getURL("images/icon128.png");(function(){var c=m();a.highlight&&b.tab?S.highlight(b.tab.id,c.resolve):c.resolve();return c.promise()})().then(function(){var b=m();a.text?S.show(a.title,a.text,d,a.timeout,b.resolve):b.resolve();return b.promise()}).always(function(a){c({clicked:a&&a.clicked})})}},determineScriptsToRun:{allow:{extpage:!0},exec:function(a,b,c){c({scripts:w.determineScriptsToRun(a.url).map(function(a){return a.uuid})})}},
syntaxCheck:{allow:{script:!0,extpage:!0},exec:function(a,b,c){(function(){var a=m();Registry.require("hinter",function(){a.resolve(Registry.get("hinter"))});return a.promise()})().then(function(b){return b.hint(a.code,e.values.editor_linter_config||void 0)}).always(function(a){c({errors:a})})}},externalMessage:{allow:{insecure:!0},exec:function(a,b,d){a=a.request;var k;if("off"!=e.values.external_connect&&(k=b.url)&&T.isAllowed(k)){for(var g,h,l,q=Object.keys(c.externally_connectable),x=0;x<q.length;x++)if(g=
q[x],b=c.externally_connectable[g],(h=w.regexify({match:[g]}))&&w.validUrl(k,h)&&(-1!=b.indexOf("*")||-1!=b.indexOf(a.method))){l=!0;break}if(l)if("getVersion"==a.method)d({version:rea.extension.manifest.version,id:rea.runtime.short_id});else if("all"!=e.values.external_connect)n.warn("mh: calling external method "+a.method+" is not permitted to "+k+" by the user");else if("isInstalled"==a.method){var m,A,p,t;k=!1;h=a.script.name;(A=z.getUidsByName(h,a.script.namespace)[0])&&(m=z.getByUid(A))&&m.script&&
(k=!0,t=m.script.enabled,p=m.script.version);d({name:h,installed:k,enabled:t,version:p})}else n.warn("mh: unknown external method "+a.method);else n.warn("mh: calling external method "+a.method+" is not permitted to "+k)}}},cookie:{allow:{script:!0},exec:function(a,b,c){var d="expirationDate domain httpOnly secure session name path sameSite value".split(" ").concat(["url"]),e=d.concat(["hostOnly"]);b=a.url||b.url||null;if(b=a.details.url?B.sanitize(a.details.url,b)||a.details.url:b)if(T.isAllowed(B.woHash(b)))if(w.scriptWillRun(a.uuid,
b))if("list"==a.action)ra.getAll({url:b,domain:a.details.domain,name:a.details.name,path:a.details.path}).done(function(a){a=a.map(function(a){var b={};e.forEach(function(c){b[c]=a[c]});return b});c({data:{cookies:a}})});else if("delete"==a.action)ra.remove({url:b,name:a.details.name}).done(function(){c({data:{success:!0}})}).fail(function(a){c({data:{error:a}})});else if("set"==a.action){var g={},h=a.details;d.forEach(function(a){void 0!==h[a]&&(-1!=["value","name"].indexOf(a)?g[a]=String(h[a]):
g[a]=h[a])});g.url=g.url||b;ra.set(g).done(function(){c({data:{success:!0}})}).fail(function(a){c({data:{error:a}})})}else c({data:{error:"unknown action"}});else c({data:{error:"the URL needs to be included by the scripts @include or @match tag"}});else c({data:{error:"the URL is filtered by the security settings"}});else c({data:{error:"invalid URL"}})}},api:{allow:{script:!0},exec:function(a,b,c){N.tA(a.name,a.type);c()}}},q=function(a){var b=rea.runtime.id,b=!p.REQUESTS.HAS_SENDER_ID&&a.tab||
a.id===b,c=null,d=p.REQUESTS.INTERNAL_PAGE_PROTOCOL+"//",e=p.REQUESTS.GET_INTERNAL_PAGE_REGEXP();a=a.url?a.url:a.tab?a.tab.url:null;if(d=b&&(a?0==a.search(d):!0))a?(e=a.match(e))&&2==e.length&&(c=e[1]):c="*";return{id_valid:b,url:a,page:c,extpage:d}},g=function(a,b,c){if(!H.late)return H.registerLateCallback(function(){g(a,b,c)}),!0;var d=A[a.method];if(!d)return n.warn("mh: unknown method "+a.method),!1;if(!d.allow||!d.exec)return n.warn("mh: invalid implementation of "+a.method),!1;var e=q(b),h=
e.extpage,l=e.page,e=e.id_valid;h?b.extpage=l:delete a.origin;var m="options"==l,x=!0;if("background"==l||d.allow.insecure||d.allow.extpage&&h||d.allow.options&&m||d.allow.script&&e&&!h){if(d=d.exec(a,b,function(a){x=!1;c(a)}),!1!==x&&!1!==d)return!0}else return!1===a.topframe&&(h||m)||n.warn("mh: this context doesn't have the permission to call \""+a.method+'"'),!1},h={xhr:{allow:{script:!0},exec:function(a,b,c,d){var g=!1,h=function(){a.disconnect()};b.details.convertBinary=!0;b.details.partialSize=
b.details.partialSize||p.XMLHTTPREQUEST.PARTIAL_SIZE;var l={};Object.keys(b.callbacks).forEach(function(a){var c="ondone"===a;if(b.callbacks[a]||c||"onload"===a)l[a]=function(b){b={data:b.response,exception:b.exception};b[a]=!0;d(b);c&&h()}});l.ondone||(l.ondone=h);var q;b.details.url=B.sanitize(b.details.url,b.url||c.url||null)||b.details.url;p.RUNTIME.WEBREQUEST_XHR_SUPPORT&&"no"!=e.values.webrequest_modHeaders&&(b.details.headers=b.details.headers||{},b.details.headers.internal=b.uuid,p.REQUESTS.SENDS_ORIGIN&&
-1==Object.keys(b.details.headers).map(function(a){return a.toLowerCase()}).indexOf("origin")&&(b.details.headers.origin=null));(function(){return b.details.cookie&&b.details.url?ra.getAll({url:b.details.url}).then(function(a){a=a.map(function(a){return a.name+"="+encodeURIComponent(a.value)}).concat([b.details.cookie]).join(";");delete b.details.cookie;b.details.headers=b.details.headers||{};b.details.headers.cookie=a}):m.Pledge()})().then(function(){if(!g){var a;if(b.details.url&&(a=B.parse(b.details.url).protocol)&&
-1!=["file:",p.REQUESTS.INTERNAL_PAGE_PROTOCOL].indexOf(a)){var d=function(a){var c='Refused to connect to "'+b.details.url+'": '+a,d=ba.makeErrorResponse(c);["onerror","ondone"].forEach(function(a){if(l[a])l[a]({response:d,exception:c})})};if("file:"==a){var k,h;p.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS&&("all"==e.values.script_file_access?k=!0:"externals"==e.values.script_file_access&&(h=z.getByUid(b.uuid))&&h.script&&h.cond&&-1!=[].concat(h.script.resources).concat(h.script.requires).map(function(a){return B.sanitize(a.unsafe_url,
a.abs_url)}).indexOf(b.details.url)&&(k=!0));if(!k)return d("Access to this local file is forbidden!")}rea.file.get(b.details.url,function(a){var b={response_data:J.arrbuf2str(a),readyState:4,responseHeaders:"",status:0,statusText:""};["onload","ondone"].forEach(function(a){if(l[a])l[a]({response:b})})},d)}else q=ha.exec(b.details,b.uuid,c||{},l)}});return function(){g=!0;q&&q.abort()}}},download:{allow:{script:!0},exec:function(a,b,c,d){b=b.details;b.internal=null===a;var e=I.start(b,{onload:function(a){d&&
d({load:!0,data:a})},onprogress:function(a){d&&d({progress:!0,data:a})},onerror:function(a){d&&d({error:!0,data:a})},ontimeout:function(a){d&&d({timeout:!0,data:a})},ondone:function(){a&&a.disconnect();a=null}});a&&void 0!==e&&a.onMessage.addListener(function(a){a.cancel&&null!==e&&(I.cancel(e),e=null)});return function(){d=a=null}}},webRequest:{allow:{script:!0},exec:function(a,b,c,d){a=c.tab.id;c=c.frameId;(void 0!==a&&void 0!==c||!b.uuid)&&ga.scripts.set(a,c,b.uuid,b.rules,function(a){d(a)})}},
addStorageListener:{allow:{script:!0},exec:function(a,b,c,d){if(c.tab)return z.addStorageListener(c.tab.id,b.id,b.uuid,Date.now(),d),function(){z.removeStorageListeners({uuid:b.uuid,id:b.id},!1)};d({error:!0})}},saveStorageKey:{allow:{script:!0},exec:function(a,b,c,d){c.tab?b.uuid&&(a=z.getStorageByUid(b.uuid),a.data[b.key]=b.value,a.ts=b.ts,z.setStorageByUid(b.uuid,a),z.notifyStorageListeners({uuid:b.uuid},{id:b.id},function(a){var c={data:{},ts:0};c.data[b.key]=b.value;c.ts=b.ts;var d={storage:c};
void 0===c.data[b.key]&&(d.removed=b.key);a(d)})):n.warn("storage: unable to save storage due to empty tabID!");d({})}},openInTab:{allow:{script:!0},exec:function(a,b,c,d){var e=["active"],g={url:b.details.url},h=null;if(b=b.details.options){for(var l=0;l<e.length;l++)void 0!==b[e[l]]&&(g[e[l]]=b[e[l]]);b.insert&&(g.index=c.tab.index+1);b.setParent&&(g.parent=c.tab)}rea.tabs.create(g,function(b){h=b.id;a&&(fa[h]={onClose:function(){a&&d({closed:!0})}},d({success:!0,tabId:h}))});a.onMessage.addListener(function(a){if(null!==
h)if(a.close)rea.tabs.remove(h),h=null;else if(void 0!==a.name){var b=3,c=function(){F.listeners.once.whenReady(h,function(){rea.tabs.sendMessage(h,{method:"setForeignAttr",attr:"name",value:a.name},function(f){f?d({name:a.name}):0<b--?c():n.warn("foreignAttr: error setting attr")})})};c()}});return function(){null!==h&&delete fa[h];a=null}}},registerMenuCommand:{allow:{script:!0},exec:function(a,b,c,d){if(c.tab)return ea.add(c.tab.id,b.name,b.uuid,b.accessKey,b.menuId,d),O.actionPage("update"),function(){ea.clearById(b.menuId);
O.actionPage("update")};n.warn("Unable to register menu cmd due to empty tabID!");a.disconnect()}},tabWatch:{allow:{extpage:!0},exec:function(a,b,c,d){var e=va.openAndWatch({url:b.url,index:(c.tab.index||0)+1,parent:c.tab},function(b){b?d({tab:b}):(g(),a.disconnect())}),g=function(){e.cancel()};return g}}},l=function(){var a=function(a,c){var d=a.sender,e=h[c.method];if(!e)return n.warn("mh: unknown method "+c.method),!1;if(!e.allow||!e.exec)return n.warn("mh: invalid implementation of "+c.method),
!1;var g=q(d),l=g.extpage,m=g.page,x="options"==m,g=g.id_valid&&!l;if("background"==m||e.allow.insecure||e.allow.extpage&&l||e.allow.options&&x||e.allow.script&&g)(d=e.exec(a,c,d,function(c){try{a.postMessage(c)}catch(d){n.debug("bg: Error sending port ("+a.name+") message",c)}}))&&a.onDisconnect.addListener(d);else return!1===c.topframe&&(l||x)||n.warn("mh: this context doesn't have the permission to call \""+c.method+'"'),!1};return function(c){H.late?c.onMessage.addListener(function(d){void 0!==
d.method&&a(c,d)}):H.registerLateCallback(function(){l(c)})}}(),c={init:function(){c.externally_connectable_reg=w.regexify({match:Object.keys(c.externally_connectable)});rea.extension.onMessage.addListener(g);rea.extension.onConnect.addListener(l);rea.extension.onConnectExternal.addListener(function(a){a.disconnect()})},externally_connectable:{"*://tampermonkey.net/*":["getVersion"],"https://greasyfork.org/*":["*"],"https://userstyles.org/*":["*"]}};return c}(),ra=function(){return{getAll:function(d){var e=
m();rea.cookies.getAll(d,e.resolve);return e.promise()},remove:function(d){var e=m();rea.cookies.remove(d,function(d){d?e.resolve():e.reject(rea.runtime.lastError||"unknown error")});return e.promise()},set:function(d){var e=m();rea.cookies.set(d,function(d){d?e.resolve():e.reject(rea.runtime.lastError||"unknown error")});return e.promise()}}}(),ea=function(){var d=[];return{add:function(e,g,h,l,c,a){d.push({tabId:e,name:g,uuid:h,accessKey:l,id:c,response:a})},list:function(){return d},listByTabId:function(e){var g=
{};return d.filter(function(d){var l=d.uuid+d.name;return d.tabId==e&&!g[l]&&(g[l]=!0)})},clearByTabId:function(e){d=d.filter(function(d){return d.tabId!=e})},getByTabId:function(e){return d.filter(function(d){return d.tabId==e})[0]},clearById:function(e){d=d.filter(function(d){return d.id!=e})},getById:function(e){return d.filter(function(d){return d.id==e})[0]}}}(),Ia=function(){return{create:function(){var m,q,g,h,l,c,a,b,f,k,u,r,t,y;k=null;m={name:d.getMessage("General"),sub_menu_item:!0,items:[]};
m.items.push({name:d.getMessage("Config_Mode"),id:"configMode",level:0,option:!0,select:[{name:d.getMessage("Novice"),value:0},{name:d.getMessage("Beginner"),value:50},{name:d.getMessage("Advanced"),value:100}],value:e.values.configMode,desc:d.getMessage("Changes_the_number_of_visible_config_options")});m.items.push({name:d.getMessage("Language"),id:"i18n",level:0,option:!0,reload:!0,warning:d.getMessage("A_reload_is_required"),select:[{name:"Browser Default",value:null}].concat(d.supported),value:e.values.i18n,
validation:{image:"info",opacity:.9,msg:d.getMessage("Your_language_is_not_supported__Click_here_to_get_intructions_how_to_translate_TM_"),url:"https://tampermonkey.net/faq.php#Q500"}});m.items.push({name:d.getMessage("Auto_reload_on_script_enabled"),level:20,id:"autoReload",option:!0,checkbox:!0,enabled:e.values.autoReload,desc:d.getMessage("Auto_reload_on_script_enabled_desc")});m.items.push({name:d.getMessage("Anonymous_statistics"),level:0,id:"statistics_enabled",option:!0,checkbox:!0,enabled:!!e.values.statistics_enabled,
validation:{image:"info",opacity:.9,msg:d.getMessage("Allow_Tampermonkey_to_collect_anonymous_statistics_via_Google_Analytics"),url:"https://tampermonkey.net/privacy.php#extension"}});m.items.push({name:d.getMessage("Debug_scripts"),level:100,id:"debug",option:!0,checkbox:!0,enabled:e.values.debug,desc:""});m.items.push({name:d.getMessage("Show_fixed_source"),level:100,id:"showFixedSrc",option:!0,checkbox:!0,enabled:e.values.showFixedSrc,desc:""});m.items.push({name:d.getMessage("LogLevel"),id:"logLevel",
level:0,option:!0,select:[{name:d.getMessage("Debug"),value:60},{name:d.getMessage("Warning"),value:30},{name:d.getMessage("Error"),value:0}],value:e.values.logLevel,desc:""});p.OPTIONS.NATIVE_SCRIPT_IMPORT&&(q={name:d.getMessage("Native_Script_Import"),sub_menu_item:!0,need_save:!0,items:[]},k={},e.values.native_import&&(k=!0===p.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS?{image:"button_ok",msg:d.getMessage("TM_has_access_to_file_URIs")}:{image:"critical",msg:d.getMessage("Tampermonkey_needs_access_to_file_URIs__Visit_the_FAQ_"),
url:"https://tampermonkey.net/faq.php#Q204"}),q.items.push({name:d.getMessage("Enable_Native_Script_Import"),id:"native_import",level:0,option:!0,checkbox:!0,enabled:e.values.native_import,validation:k}),q.items.push({name:d.getMessage("Post_Import_Action"),id:"native_import_post_action",level:0,option:!0,select:[{name:d.getMessage("None"),value:"none"},{name:d.getMessage("Disable_Extension"),value:"disable"},{name:d.getMessage("Uninstall_Extension"),value:"uninstall"}],value:e.values.native_import_post_action,
desc:d.getMessage("What_action_should_be_done_after_a_native_userscript_was_imported_sucessfully_")}),k={},e.values.native_import&&(k=Q.isPathValid()?{image:"button_ok",msg:d.getMessage("Everything_is_setup_correctly_")}:{image:"critical",msg:d.getMessage("Tampermonkey_needs_to_know_the_absolute_path_to_your_browser_profile_folder_Visit_the_FAQ_"),url:"https://tampermonkey.net/faq.php#Q205"}),q.items.push({name:d.getMessage("Browser_Profile_Path"),id:"native_import_path",level:0,option:!0,text:!0,
width:2,value:e.values.native_import_path,validation:k}));r={name:d.getMessage("Script_Sync"),sub_menu_item:!0,level:50,need_save:!0,items:[]};r.items.push({name:d.getMessage("Enable_Script_Sync"),id:"sync_enabled",level:50,option:!0,checkbox:!0,enabled:e.values.sync_enabled,desc:d.getMessage("Synchronize_your_scripts_across_browsers_and_operation_systems")});g=function(){var a=[],c={reset_sync:!0,cloud_url:!1,cloud_user:!1,cloud_pass:!1};rea.storage.sync.supported&&a.push({name:d.getMessage("Browser_Sync"),
value:G.types.eCHROMESYNC,enable:c});a.push({name:"Google Drive",value:G.types.eGDRIVE,enable:c});p.RUNTIME.CHROME&&37>p.RUNTIME.BROWSER_VERSION||p.RUNTIME.SAFARI&&8>p.RUNTIME.BROWSER_VERSION||p.RUNTIME.DOLPHIN?n.info("Script Sync: no Dropbox support due to missing SHA-256 capabilities"):a.push({name:"Dropbox",value:G.types.eDROPBOX,enable:c});a.push({name:"WebDAV",value:G.types.eWEBDAV,enable:{reset_sync:!0,cloud_url:!0,cloud_user:!0,cloud_pass:!0}});return a}();r.items.push({name:d.getMessage("Sync_Type"),
id:"sync_type",enabler:!0,level:50,option:!0,select:g,value:e.values.sync_type});r.items.push({name:d.getMessage("URL"),id:"cloud_url",enabledBy:"sync_type",level:50,option:!0,text:!0,width:2,value:e.values.cloud_url});r.items.push({name:d.getMessage("Login"),id:"cloud_user",enabledBy:"sync_type",level:50,option:!0,text:!0,width:2,value:e.values.cloud_user});r.items.push({name:d.getMessage("Password"),id:"cloud_pass",enabledBy:"sync_type",level:50,option:!0,text:!0,password:!0,width:2,value:e.values.cloud_pass});
r.items.push({name:d.getMessage("Sync_Reset"),id:"reset_sync",enabledBy:"sync_type",level:80,button:!0,reload:!0,value:0,warning:d.getMessage("This_will_remove_all_remote_data_from_sync_Ok_")});c={name:d.getMessage("Appearance"),sub_menu_item:!0,need_save:!0,items:[],warning:d.getMessage("A_reload_is_required"),reload:!0};c.items.push({name:d.getMessage("Layout"),id:"layout",level:0,option:!0,select:ka.getLayouts(),value:e.values.layout,desc:""});c.items.push({name:d.getMessage("Custom_CSS"),id:"layout_user_css",
level:100,option:!0,input:!0,value:e.values.layout_user_css,desc:d.getMessage("You_can_add_your_custom_CSS_rules_here_")});k={};"off"==e.values.notification_showUpdate&&(k={image:"critical",msg:d.getMessage("Are_you_sure_that_you_don_t_want_to_be_notified_of_updates_")});c.items.push({name:d.getMessage("Update_Notification"),id:"notification_showUpdate",level:50,option:!0,select:[{name:d.getMessage("Disabled"),value:"off"},{name:d.getMessage("Show_notification"),value:"notification"},{name:d.getMessage("Open_changelog"),
value:"changelog"}],value:e.values.notification_showUpdate,validation:k});c.items.push({name:d.getMessage("Favicon_Service"),id:"favicon_service",level:50,option:!0,select:[{name:d.getMessage("Google"),value:"google"},{name:d.getMessage("DuckDuckGo"),value:"duckduckgo"},{name:d.getMessage("Native"),value:"native",warning:d.getMessage("Warning_unsafe_site_warnings_might_appear_")}],value:e.values.favicon_service});a={name:d.getMessage("Action_Menu"),sub_menu_item:!0,need_save:!0,items:[],level:50};
a.items.push({name:d.getMessage("Hide_disabled_scripts"),id:"action_menu_scripts_hide_disabled",level:100,option:!0,checkbox:!0,enabled:e.values.action_menu_scripts_hide_disabled,desc:""});a.items.push({name:d.getMessage("Columns"),id:"action_menu_columns",level:50,option:!0,select:[{name:d.getMessage("1"),value:"1"},{name:d.getMessage("2"),value:"2"},{name:d.getMessage("3"),value:"3"}],value:e.values.action_menu_columns});a.items.push({name:d.getMessage("Script_order"),id:"action_menu_scripts_sort",
level:50,option:!0,select:[{name:d.getMessage("Auto"),value:"auto"},{name:d.getMessage("Position_"),value:"position"},{name:d.getMessage("Name"),value:"name"},{name:d.getMessage("Enabled"),value:"enabled"}],value:e.values.action_menu_scripts_sort});a.items.push({name:d.getMessage("Icon_badge_info"),id:"appearance_badges",level:50,option:!0,select:[{name:d.getMessage("Disabled"),value:"off"},{name:d.getMessage("Running_scripts"),value:"running"},{name:d.getMessage("Unique_running_scripts"),value:"running_unique"},
{name:d.getMessage("Disabled_scripts"),value:"disabled"}],value:e.values.appearance_badges});(p.RUNTIME.CHROME||p.RUNTIME.FIREFOX)&&a.items.push({name:d.getMessage("Icon_badge_color"),id:"appearance_badge_color",level:100,color:!0,value:e.values.appearance_badge_color});g={name:d.getMessage("Editor"),sub_menu_item:!0,level:20,need_save:!0,items:[],warning:d.getMessage("A_reload_is_required"),reload:!0};g.items.push({name:d.getMessage("Enable_Editor"),id:"editor_enabled",level:100,option:!0,checkbox:!0,
enabled:e.values.editor_enabled,desc:""});g.items.push({name:d.getMessage("Theme"),id:"editor_theme",level:50,option:!0,select:ka.getEditorThemes(),value:e.values.editor_theme});g.items.push({name:d.getMessage("Font_Size"),id:"editor_fontSize",level:50,option:!0,select:[{name:"50%",value:50},{name:"70%",value:70},{name:"80%",value:80},{name:"90%",value:90},{name:"100%",value:100},{name:"110%",value:110},{name:"120%",value:120},{name:"150%",value:150}],value:e.values.editor_fontSize});g.items.push({name:d.getMessage("Key_Mapping"),
id:"editor_keyMap",level:50,option:!0,select:[{name:d.getMessage("Windows"),value:"windows"},{name:d.getMessage("Sublime"),value:"sublime"},{name:d.getMessage("Emacs"),value:"emacs"},{name:d.getMessage("Vim"),value:"vim"}],value:e.values.editor_keyMap});g.items.push({name:d.getMessage("Indentation_Width"),id:"editor_indentUnit",level:50,option:!0,select:[{name:d.getMessage("1"),value:1},{name:d.getMessage("2"),value:2},{name:d.getMessage("3"),value:3},{name:d.getMessage("4"),value:4},{name:d.getMessage("5"),
value:5},{name:d.getMessage("6"),value:6},{name:d.getMessage("7"),value:7},{name:d.getMessage("8"),value:8},{name:d.getMessage("9"),value:9},{name:d.getMessage("10"),value:10},{name:d.getMessage("11"),value:11}],value:e.values.editor_indentUnit,desc:""});g.items.push({name:d.getMessage("Indent_with"),id:"editor_indentWithTabs",level:50,option:!0,select:[{name:d.getMessage("Tabs"),value:"tabs"},{name:d.getMessage("Spaces"),value:"spaces"}],value:e.values.editor_indentWithTabs,desc:""});g.items.push({name:d.getMessage("TabMode"),
id:"editor_tabMode",level:50,option:!0,select:[{name:d.getMessage("Classic"),value:"classic"},{name:d.getMessage("Smart"),value:"smart"},{name:d.getMessage("Indent"),value:"indent"}],value:e.values.editor_tabMode,desc:""});g.items.push({name:d.getMessage("Line_break"),id:"editor_lineWrapping",level:50,option:!0,checkbox:!0,enabled:e.values.editor_lineWrapping,desc:""});g.items.push({name:d.getMessage("Reindent_on_typing"),id:"editor_electricChars",level:50,option:!0,checkbox:!0,enabled:e.values.editor_electricChars,
desc:""});g.items.push({name:d.getMessage("Enable_autoSave"),id:"editor_autoSave",level:20,option:!0,checkbox:!0,enabled:e.values.editor_autoSave,desc:""});g.items.push({name:d.getMessage("Enable_easySave"),id:"editor_easySave",level:20,option:!0,checkbox:!0,enabled:e.values.editor_easySave,desc:""});g.items.push({name:d.getMessage("Highlight_trailing_whitespace"),id:"editor_highlightTrailingWhitespace",level:50,option:!0,checkbox:!0,enabled:e.values.editor_highlightTrailingWhitespace,desc:""});g.items.push({name:d.getMessage("Trim_trailing_whitespace_from_modified_lines"),
id:"editor_trimTrailingSpacesFromModifiedLines",level:50,option:!0,checkbox:!0,enabled:e.values.editor_trimTrailingSpacesFromModifiedLines,desc:""});g.items.push({name:d.getMessage("Auto_syntax_check_on_typing"),id:"editor_autoLint",level:50,option:!0,checkbox:!0,enabled:e.values.editor_autoLint,desc:d.getMessage("Enable_this_option_to_automatically_check_the_code_on_typing_")});g.items.push({name:d.getMessage("Auto_syntax_check_max_length"),id:"editor_autoLintMaxLen",level:50,option:!0,text:!0,value:e.values.editor_autoLintMaxLen,
desc:d.getMessage("Check_only_scripts_up_to_this_size_automatically_")});g.items.push({name:d.getMessage("Custom_Linter_Config"),id:"editor_linter_config",level:100,option:!0,input:!0,json:!0,value:e.values.editor_linter_config,validation:{image:"info",opacity:.9,msg:d.getMessage("You_can_add_your_custom_linter_config_here_"),url:"https://eslint.org/docs/user-guide/configuring"}});l={name:d.getMessage("Script_Update"),sub_menu_item:!0,level:0,items:[]};l.items.push({name:d.getMessage("Check_disabled_scripts"),
id:"scriptUpdateCheckDisabled",level:0,option:!0,checkbox:!0,enabled:e.values.scriptUpdateCheckDisabled,desc:""});l.items.push({name:d.getMessage("Dont_ask_me_for_simple_script_updates"),id:"notification_silentScriptUpdate",level:80,option:!0,checkbox:!0,enabled:e.values.notification_silentScriptUpdate,desc:""});l.items.push({name:d.getMessage("Check_interval"),id:"scriptUpdateCheckPeriod",level:0,option:!0,select:[{name:d.getMessage("Never"),value:0},{name:d.getMessage("Every_6_Hours"),value:216E5},
{name:d.getMessage("Every_12_Hour"),value:432E5},{name:d.getMessage("Every_Day"),value:864E5},{name:d.getMessage("Every_Week"),value:6048E5}],value:e.values.scriptUpdateCheckPeriod,desc:""});l.items.push({name:d.getMessage("Hide_notification_after"),id:"scriptUpdateHideNotificationAfter",level:50,option:!0,select:[{name:d.getMessage("Never"),value:0},{name:d.getMessage("15_Seconds"),value:15E3},{name:d.getMessage("30_Seconds"),value:3E4},{name:d.getMessage("1_Minute"),value:6E4},{name:d.getMessage("5_Minutes"),
value:3E5},{name:d.getMessage("1_Hour"),value:36E5}],value:e.values.scriptUpdateHideNotificationAfter,desc:""});h={name:d.getMessage("Externals"),sub_menu_item:!0,level:0,items:[]};h.items.push({name:d.getMessage("Update_interval"),id:"external_update_interval",level:0,option:!0,select:[{name:d.getMessage("Always"),value:1},{name:d.getMessage("Every_Day"),value:864E5},{name:d.getMessage("Every_Week"),value:6048E5},{name:d.getMessage("Every_Month"),value:2592E6},{name:d.getMessage("Never"),value:0}],
value:e.values.external_update_interval,desc:""});b={name:d.getMessage("Security"),sub_menu_item:!0,need_save:!0,level:50,items:[]};p.OPTIONS.HAS_CSP&&(b.items.push({name:d.getMessage("Add_TM_to_CSP"),id:"webrequest_fixCSP",level:80,option:!0,select:[{name:d.getMessage("Yes"),value:"yes"},{name:d.getMessage("No"),value:"no"}],value:e.values.webrequest_fixCSP,desc:d.getMessage("Tampermonkey_might_not_be_able_to_provide_access_to_the_unsafe_context_when_this_is_disabled")}),b.items.push({name:d.getMessage("Allow_headers_to_be_modified_by_scripts"),
id:"webrequest_modHeaders",level:80,option:!0,reload:!0,select:[{name:d.getMessage("Yes"),value:"yes"},{name:d.getMessage("Auto"),value:"auto"},{name:d.getMessage("No"),value:"no"}],value:e.values.webrequest_modHeaders,warning:d.getMessage("Tampermonkey_needs_to_be_restarted_to_make_this_change_apply_Do_you_want_to_continue_"),desc:""}));p.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS&&b.items.push({name:d.getMessage("Script_local_files_access"),id:"script_file_access",level:80,option:!0,select:[{name:d.getMessage("All_local_files"),
value:"all"},{name:d.getMessage("require_and_resource"),value:"externals"},{name:d.getMessage("Disabled"),value:"off"}],value:e.values.script_file_access});b.items.push({name:d.getMessage("Allow_communication_with_cooperate_pages"),id:"external_connect",level:80,option:!0,reload:!0,select:[{name:d.getMessage("Tampermonkey_and_script_version"),value:"all"},{name:d.getMessage("Tampermonkey_version"),value:"version"},{name:d.getMessage("Disabled"),value:"off"}],value:e.values.external_connect,desc:d.getMessage("This_option_allows_the_Tampermonkey_homepage_and_some_script_hosting_pages_to_determine_the_Tampermonkey_version_and_whether_a_script_is_installed_")});
b.items.push({name:d.getMessage("Subresource_Integrity"),id:"require_sri_mode",level:80,option:!0,select:[{name:d.getMessage("Disabled"),value:"ignore"},{name:d.getMessage("Validate_if_supported"),value:"supported"},{name:d.getMessage("Validate_if_given"),value:"given"},{name:d.getMessage("Enforce"),value:"enforce"}],value:e.values.require_sri_mode,desc:d.getMessage("Script_authors_can_secure_external_resources_by_adding_a_SRI_hash_to_the_URL_")});b.items.push({name:d.getMessage("connect_mode"),id:"connect_mode",
level:50,option:!0,select:(80<=e.values.configMode||-1!=["off","casual"].indexOf(e.values.connect_mode)?[{name:d.getMessage("Disabled"),value:"off"},{name:d.getMessage("Casual"),value:"casual"}]:[]).concat([{name:d.getMessage("Ask_if_unknown"),value:"ask"},{name:d.getMessage("Strict"),value:"strict"},{name:d.getMessage("Always_ask"),value:"paranoid"}]),value:e.values.connect_mode,desc:""});p.RUNTIME.INCOGNITO_MODE&&!rea.extension.inIncognitoContext&&(k="temporary"==e.values.incognito_mode?{}:{image:"critical",
msg:"Permanent mode is still a BETA feature!"},b.items.push({name:d.getMessage("Store_data_in_incognito_mode"),id:"incognito_mode",level:50,option:!0,select:[{name:d.getMessage("Temporary"),value:"temporary"},{name:d.getMessage("Permanent"),value:"permanent"}],value:e.values.incognito_mode,validation:k}));b.items.push({name:d.getMessage("Page_Filter_Mode"),id:"page_filter_mode",level:50,option:!0,select:[{name:d.getMessage("Disabled"),value:"off"},{name:d.getMessage("Blacklist"),value:"black"},{name:d.getMessage("Whitelist"),
value:"white"},{name:d.getMessage("Both"),value:"black+white"}],value:e.values.page_filter_mode,desc:""});b.items.push({name:d.getMessage("Whitelisted_Pages"),id:"page_whitelist",level:50,option:!0,input:!0,array:!0,value:e.values.page_whitelist,desc:""});b.items.push({name:d.getMessage("Blacklisted_Pages"),id:"forbiddenPages",level:50,option:!0,input:!0,array:!0,value:e.values.forbiddenPages,desc:""});f={name:d.getMessage("BlackCheck"),sub_menu_item:!0,need_save:!0,level:50,items:[]};f.items.push({name:d.getMessage("Script_Blacklist_Source"),
id:"script_blacklist_type",level:50,option:!0,select:[{name:d.getMessage("Disabled"),value:"off"},{name:d.getMessage("Server_And_Manual"),value:"server"},{name:d.getMessage("Only_Manual"),value:"only_manual"}],value:e.values.script_blacklist_type});f.items.push({name:d.getMessage("Blacklist_Severity"),id:"script_blacklist_severity",level:50,option:!0,select:[{name:d.getMessage("severity_1"),value:1},{name:d.getMessage("severity_2"),value:2},{name:d.getMessage("severity_3"),value:3},{name:d.getMessage("severity_4"),
value:4},{name:d.getMessage("severity_5"),value:5},{name:d.getMessage("severity_6"),value:6},{name:d.getMessage("severity_7"),value:7},{name:d.getMessage("severity_8"),value:8},{name:d.getMessage("severity_9"),value:9},{name:d.getMessage("severity_10"),value:K.SEVERITY_MAX}],value:e.values.script_blacklist_severity});f.items.push({name:d.getMessage("Manual_Script_Blacklist"),id:"require_blacklist",level:50,option:!0,input:!0,array:!0,value:e.values.require_blacklist,desc:""});if(p.OPTIONS.CAN_DOWNLOAD){var x=
!1;k={};v.map("exe sh crx com bat scr".split(" "),function(a){return"name."+a}).forEach(function(a){x|=I.is_whitelisted(a)});x&&(k={image:"critical",msg:d.getMessage("Your_whitelist_seems_to_include_executable_files_This_means_your_userscripts_may_download_malware_or_spyware_to_your_harddisk_")});y={name:d.getMessage("Downloads")+" BETA",sub_menu_item:!0,need_save:!0,level:50,items:[]};y.items.push({name:d.getMessage("Download_Mode"),id:"downloads_mode",level:50,option:!0,select:v.select([{name:d.getMessage("Default"),
value:I.staticVars.DEFAULT},{name:d.getMessage("Disabled"),value:I.staticVars.OFF},{name:d.getMessage("Native"),value:I.staticVars.NATIVE},{name:d.getMessage("Browser_API"),value:rea.downloads.supported?I.staticVars.CHROME:null}],function(a){return a.value}),value:e.values.downloads_mode,desc:d.getMessage("The_Browser_API_mode_requires_a_special_permission_")});y.items.push({name:d.getMessage("Whitelisted_File_Extensions"),id:"downloads_extension_whitelist",level:50,option:!0,input:!0,array:!0,value:e.values.downloads_extension_whitelist,
desc:d.getMessage("Only_files_with_these_extensions_can_be_saved_to_the_harddisk_Be_careful_to_not_allow_file_extensions_that_represent_executables_at_your_operating_system_"),validation:k})}u={name:d.getMessage("Experimental"),sub_menu_item:!0,level:80,items:[]};p.RUNTIME.FAST_EXEC_SUPPORT&&(k="fast"==e.values.runtime_inject_mode?{image:"critical",msg:"This might cause higher CPU usage!"}:{},u.items.push({name:d.getMessage("Inject_Mode"),id:"runtime_inject_mode",level:80,option:!0,select:[{name:d.getMessage("Default"),
value:"default"},{name:d.getMessage("Instant"),value:"instant"},{name:d.getMessage("Normal"),value:"normal"}],value:e.values.runtime_inject_mode,validation:k}));u.items.push({name:d.getMessage("strict_mode"),id:"runtime_strict_mode",level:80,option:!0,select:[{name:d.getMessage("Default"),value:"byscript"},{name:d.getMessage("Always"),value:"on"},{name:d.getMessage("Disabled"),value:"off"}],value:e.values.runtime_strict_mode});rea.webRequest.filterResponseData&&p.OPTIONS.HAS_CSP&&u.items.push({name:"Add Tampermonkey to the sites content CSP",
id:"webrequest_fixContentCSP",level:80,option:!0,select:[{name:d.getMessage("Yes"),value:"yes"},{name:d.getMessage("No"),value:"no"}],value:e.values.webrequest_fixContentCSP,warning:"Warning: enabling this option is may break pages!"});k={name:d.getMessage("Userscripts"),sub_menu_item:!0,need_save:!0,level:80,items:[]};k.items.push({name:d.getMessage("Script_URL_detection"),id:"scriptUrlDetection",level:80,option:!0,select:[{name:d.getMessage("Auto"),value:"auto"},{name:d.getMessage("Disabled"),value:"manual"}],
value:e.values.scriptUrlDetection});k.items.push({name:d.getMessage("New_script_template_"),id:"script_templates",level:80,option:!0,input:!0,array:!0,named:!0,value:e.values.script_templates});t={name:d.getMessage("Reset_Section"),sub_menu_item:!0,level:50,items:[]};t.items.push({name:d.getMessage("Restart_Tampermonkey"),id:"reset_simple",level:50,button:!0,reload:!0,value:0,warning:d.getMessage("This_will_restart_Tampermonkey_Ok_")});t.items.push({name:d.getMessage("Factory_Reset"),id:"reset_factory",
level:80,button:!0,reload:!0,value:0,warning:d.getMessage("This_will_remove_all_scripts_and_reset_all_settings_Ok_")});ua&&t.items.push({name:"Install Tests",id:"install_tests",level:80,button:!0,reload:!1,ignore:!0,value:0,warning:"This will install a lot of test scripts!"});return[m,c,a,l,h,void 0,r,q,void 0,g,b,f,y,k,u,t].filter(function(a){return!!a})}}}(),U=function(){return{create:function(A,q){A=A||"";q=q||{};var g=function(c){return m.onebyone(c).fail(function(){n.warn("tree: wait failed!")}).then(function(a){return a.filter(function(a){return a})})},
h=function(c,a){for(var b=c.replace(/\.$/,"").split("."),d=l;b.length;){var e=b.shift();if(d[e]){if("function"===typeof d[e])return function(){return d[e](q,!a)};d=d[e];b.length||b.unshift("root")}else return n.warn("tree: unable to find",c,q),function(){return m.Pledge([])}}n.warn("tree: unable to find",c,q);return function(){return m.Pledge([])}},l={actions:{root:function(c){var a=m();rea.tabs.getSelected(null,function(b){b&&0<=b.id?q.tab=b:c.tabId&&(q.tab={id:c.tabId,url:null});b=g([h("actions.general"),
h("actions.scripts"),h("actions.commands")]);a.consume(b)});return a.promise()},general:function(){var c=q.tab,a=c?c.url:null,b=a&&4<a.length&&""==a.substr(0,4).replace(/file|http/,"")?a:"",f=[],c={name:"enabled",sub_menu_item:!0,pos:"top",items:[],tabId:c?c.id:null};c.items.push({name:d.getMessage("Enabled"),display:e.values.enabled?null:"greyed",id:"enabled",button:!0,reload:!0,enabler:!0});c.items=c.items.concat(O.actionStatus().map(function(a){return{options:a,globalhint:!0}}));f.push(c);var g;
!oa.isScriptUrl(a,!0)||(g=oa.isScriptUrl(a))&&"manual"!=e.values.scriptUrlDetection||c.items.push({name:g?d.getMessage("Install_this_script"):d.getMessage("Try_to_install_as_script"),image:"script_download",id:"installFromUrl",data:a,button:!0,reload:!0});a={name:"about",sub_menu_item:!0,pos:"bottom",items:[]};a.items.push({name:d.getMessage("Dashboard"),image:"utilities",url:rea.extension.getURL("options.html")+"#"+["url="+J.Base64.encode(b),"nav=dashboard"].join("&"),newtab:!0});b="version="+rea.extension.manifest.version+
"&ext="+rea.runtime.short_id;a.items.push({image:"about",id:"about",urls:[{name:" "+d.getMessage("Help"),url:"https://tampermonkey.net/faq.php?"+b,newtab:!0},{name:" "+d.getMessage("Changelog"),url:"https://tampermonkey.net/changelog.php?"+b,newtab:!0}]});f.push(a);return m.Pledge(f)},scripts:{root:function(c){var a=q.tab,b=a?a.url:null,f=[],g=b?B.parse(b):null,g=g&&-1!=["http:","https:","file:"].indexOf(g.protocol)?B.woHash(g):"",h,l={name:"scripts",sub_menu_item:!0,pos:"center",items:[]},n=Y.getContexters(!0,
null),p={},x={},A={},t={};a&&[w.getUniqueScriptsForTab(a),w.getScriptHistoryForTab(a)].forEach(function(a,c){var b;Object.keys(a).forEach(function(e){var f=a[e];c?(p[e]=f.urls,x[e]=f.count,(b=A[e])||(f=z.getByUid(e),A[e]=f.script&&f.cond?b=f.script:b={uuid:e,name:d.getMessage("This_script_was_deleted"),enabled:!0,deleted:!0}),t[e]="a"+b.name.toLowerCase()+b.position):(A[e]=b=f.script,t[e]="z"+b.name.toLowerCase()+b.position)})});var ya;ya="position"==e.values.action_menu_scripts_sort?function(a,c){return a.position-
c.position}:"name"==e.values.action_menu_scripts_sort?function(a,c){return a.name.toLowerCase()<c.name.toLowerCase()?-1:a.name.toLowerCase()>c.name.toLowerCase()?1:0}:"enabled"==e.values.action_menu_scripts_sort?function(a,c){return 1E4*(a.enabled?0:1)+a.position-(1E4*(c.enabled?0:1)+c.position)}:function(a,c){return t[a.uuid].localeCompare(t[c.uuid])};var A=v.values(A).sort(ya),n=ta([].concat(A).concat(n),{active_urls:p,active_counts:x}),X=a?Ja(a.id):{};e.values.action_menu_scripts_hide_disabled&&
(n=n.filter(function(a){return a.enabled||x[a.uuid]}));n.forEach(function(a){var c;if(c=X[a.uuid])a.menu_cmds=c});!e.values.action_menu_scripts_hide_disabled&&2<Math.min(e.values.action_menu_columns,(c?c.available_columns:null)||99)?(h={name:"scripts_right",sub_menu_item:!0,pos:"right",items:[]},n.forEach(function(a){(a.enabled||x[a.uuid]?l:h).items.push(a)}),f.push(l),h.items.length&&f.push(h)):(h=l,l.items=l.items.concat(n),f.push(l));e.values.enabled&&!n.length&&b&&(T.isAllowed(b)?l.items.push({name:d.getMessage("No_script_is_running"),
image:"no_script"}):l.items.push({name:d.getMessage("This_page_is_blacklisted_at_the_security_settings"),image:"critical"}));c=d.getLocale();e.values.enabled&&("3"==e.values.action_menu_columns||100>e.values.configMode||!n.length)&&(n.length?(a={name:"scripts_new",sub_menu_item:!0,pos:"center",items:[]},f.push(a)):a=l,a.items.push({name:d.getMessage("Get_new_scripts___"),image:"script_search",url:"https://tampermonkey.net/scripts.php"+(c?"?locale="+c:""),newtab:!0}),a.items.push({name:d.getMessage("Add_new_script___"),
image:"script_add",url:rea.extension.getURL("options.html")+"#url="+J.Base64.encode(g)+"&nav=new-user-script",newtab:!0}));return m.Pledge(f)}},commands:function(){var c=[],a=d.getLocale(),b={name:"commands",id:"commands",sub_menu_item:!0,pos:"left",items:[]};b.items.push({name:d.getMessage("Check_for_userscripts_updates"),id:"run_script_updates",button:!0,image:"update"});80<=e.values.configMode&&b.items.push({name:d.getMessage("Report_a_bug"),image:"bug",url:"https://tampermonkey.net/bug",newtab:!0});
b.items.push({name:d.getMessage("Please_consider_a_contribution"),image:"contrib",url:"https://tampermonkey.net/contrib.php?src=a"+(a?"&locale="+a:""),newtab:!0});c.push(b);return m.Pledge(c)}},options:{root:function(){return g([h("options.general"),h("options.verification"),h("options.scripts"),h("options.settings")])},general:function(){var c,a=[];a.push({name:"Version",id:null,version:!0,value:rea.extension.manifest.version});rea.extension.inIncognitoContext&&"temporary"==e.values.incognito_mode?
a.push({globalhint:!0,options:{image:"critical",text:d.getMessage("All_modifications_are_only_kept_until_this_incognito_session_is_closed_")}}):(c=O.optionsStatus().map(function(a){return{options:a,globalhint:!0}}))&&c.length?a=a.concat(c):(c=za.updateAvailable())&&a.push({globalhint:!0,options:{image:"info",class:"information",text:d.getMessage("0name0_0version0_is_available__Please_re_start_your_browser_to_update_",rea.extension.manifest.name,c)}});return m.Pledge(a)},verification:function(){var c=
[];ia.getWarnings().forEach(function(a){c.push({globalhint:!0,options:{image:"critical",class:"warning",text:a.text,title:a.description,info_url:a.url}})});return m.Pledge(c)},scripts:{root:function(c,a){var b=m(),e={name:d.getMessage("Installed_userscripts"),main_menu_item:!0,scriptTab:!0,id:"dashboard"};(function(){if(c.complete||!a)return g(v.map(["options.scripts.natives","options.scripts.userscripts","options.scripts.new"],function(a){return h(a)}));e.referrer="options.scripts";e.partial=!0;
return g([h("options.scripts.new")])})().done(function(a){e.items=a;b.resolve([e])}).fail(b.reject);return b.promise()},"new":function(){var c=[];c.push({name:d.getMessage("New_userscript"),id:null,image:"script_add",icon:rea.extension.getURL("images/txt.png"),nnew:!0,uuid:"new-user-script",position:-1,positionof:p.RUNTIME.MAX_SCRIPTS,enabled:!0,userscript:!0});return m.Pledge(c)},natives:function(){var c=[],a=m();Q.getAllUserscripts().always(function(b){b=b||[];b.forEach(function(a){c.push({name:a.name,
uuid:a.id,icon:a.icon,code:null,position:0,positionof:p.RUNTIME.MAX_SCRIPTS,enabled:a.enabled,version:a.version,description:a.description,nativeScript:!0})});a.resolve(c)});return a.promise()},userscripts:{root:function(c,a){var b=c.complete||!a?null:"options.scripts.userscripts",b=ta(w.determineScriptsToRun(null),{options_page:!0,referrer:b}),e=b.length,g=d.getLocale();b.push({name:d.getMessage("No_script_is_installed"),image:"info",visible:!e});b.push({name:d.getMessage("Get_some_scripts___"),image:"edit_add",
url:"https://tampermonkey.net/scripts.php"+(g?"?locale="+g:""),newtab:!0,visible:!e});return m.Pledge(b)},matches:function(c){if(!c.uuid)return m.Pledge([]);var a=z.getByUid(c.uuid),b;return a.script&&a.cond&&(b=c.filter)?(c=/\/(.*)\/(.*)/.exec(b.code),m.Pledge([-1!=a.script.textContent.search(new RegExp(c[1],c[2]))])):m.Pledge([])},source:function(c){if(!c.uuid)return m.Pledge([]);c=z.getByUid(c.uuid);if(c.script&&c.cond)return c=e.values.showFixedSrc?qa.mkCompat(c.script.textContent,c.script,"off"!=
e.values.runtime_strict_mode):c.script.textContent,m.Pledge([c]);n.warn("tree: unable to process ",c);return m.Breach()},storage:function(c){return c.uuid?m.Pledge([z.getStorageByUid(c.uuid).data]):m.Pledge([])},external:function(c){if(!c.uuid)return m.Pledge([]);var a=z.getByUid(c.uuid);if(a.script&&a.cond){var b;[].concat(a.script.requires).concat(a.script.resources).some(function(a){a=a.url||B.sanitize(a.unsafe_url,a.abs_url);if(a==c.url&&(a=P.getElement(c.uuid,a))&&a.data&&a.data.content)return b=
a.data.content,!0});return m.Pledge([b])}n.warn("tree: unable to process ",a);return m.Breach()}}},settings:function(c,a){var b=m(),e={name:d.getMessage("Settings"),main_menu_item:!0,id:"settings",selected_default:!0},g;c.complete||!a?g=m.Pledge(Ia.create()):(e.referrer="options.settings",g=m.Pledge());g.done(function(a){e.items=a;b.resolve([e])}).fail(b.reject);return b.promise()}}};n.debug("tree: loading",A,q);return h(A,!0)()}}}(),Ja=function(d){var e={};d=null==d||void 0==d?ea.list():ea.listByTabId(d);
for(var g in d)if(d.hasOwnProperty(g)){var h=d[g];(e[h.uuid]=e[h.uuid]||[]).push({name:h.name,uuid:h.uuid,id:h.id,accessKey:h.accessKey,image:"menu_cmd",menucmd:!0})}return e},ta=function(m,q){var g=[];q=q||{};var h=new E.Script;["author","copyright"].forEach(function(d){h[d]=!1});Object.keys(m).forEach(function(l){var c=m[l],a;if(q.options_page){a={};var b=["textContent","requires","resources"];Object.keys(h).forEach(function(d){-1==b.indexOf(d)&&(v.toType(h[d]),a[d]=c[d])});q.referrer?(a.referrer=
q.referrer,a.length=c.textContent.length):a.code=c.textContent;["requires","resources"].forEach(function(b){a[b]=v.map(c[b],function(a){var d=a.url||B.sanitize(a.unsafe_url,a.abs_url),e=P.getElement(c.uuid,d),g=0,h=null,l=null,m,n,p,A;e&&e.data&&(e.data.content&&(A=e.data.content,g=A.length),l=e.data.sri,h=e.ts,m=e.modified,p=e.data.meta||"text/plain",n="requires"==b||/text\/.*|application\/(?:x-)?(?:java|ecma)script/.test(p));return{display_url:a.url||a.unsafe_url,abs_url:a.abs_url,unsafe_url:a.unsafe_url,
url:d,data:{length:g,content:q.externals?A:void 0},sri:l,ts:h,mimetype:p,editable:n,modified:m}})});a.origin=w.determineOrigin(c);a.contexter=w.isContexter(c);a.temp_connects=ha.getSessionConnects(c.uuid);l=z.getStorageByUid(c.uuid);a.storage_key_count=Object.keys(l.data).length;a.remote_url=M.getSyncRemoteUrl(c);a.lastUpdated=c.lastUpdated}else l=w.determineOrigin(c),a={name:c.name,name_i18n:c.name_i18n,uuid:c.uuid,system:c.system,support:!!c.supportURL||l&&!!l.issue_url,abuse:l&&!!l.abuse_url,active_urls:(q.active_urls||
{})[c.uuid],active_count:(q.active_counts||{})[c.uuid],referrer:q.referrer,contexter:w.isContexter(c),enabled:c.enabled,position:c.position,deleted:c.deleted};c.evilness&&(c.evilness==K.SEVERITY_FOISTED_SCRIPT?a.blacklisted=d.getMessage("This_is_a_possibly_foisted_script_and_a_modification_will_enable_it_"):c.evilness>=Math.min(K.SEVERITY_MAX,e.values.script_blacklist_severity)&&(a.blacklisted=d.getMessage("This_script_is_blacklisted_")));c.evilness&&(a.warnings=K.getWarningsFor(w.determineSourceURL(c)));
a.file_url=c.downloadURL||c.fileURL;a.positionof=m.length;a.userscript=!0;c.icon64||c.icon||(a.icon64=rea.extension.getURL("images/txt.png"));c.options&&Object.keys(h.options).forEach(function(b){a[b]=c.options[b]});g.push(a)});return g},V={run:function(d,e){var g=1,h=function(){0==--g&&(e&&e(),rea.page.reload())};if("config"==d){var l=t.listValues();Object.keys(l).forEach(function(c){c=l[c];-1==c.search(p.CONSTANTS.PREFIX.SCRIPT)&&-1==c.search(p.CONSTANTS.PREFIX.COND)&&-1==c.search(p.CONSTANTS.PREFIX.STORE)&&
-1==c.search(p.CONSTANTS.PREFIX.META)&&(g++,t.deleteValue(c).always(h))})}else"factory"==d&&(g++,I.remove_permission().done(h),g++,t.factoryReset().always(h));h()},reset:function(d){V.run(null,d)},factoryReset:function(d){V.run("factory",d)},configReset:function(d){V.run("config",d)}},R=function(){var m=function(){rea.runtime.lastError&&void 0},q={init:function(){q.setIcon();var d=e.values.appearance_badge_color||"#ee3131";"#"!==d[0]&&(d="#"+d);rea.browserAction.setBadgeBackgroundColor({color:d})},
setIcon:function(g){var h,l;l=null;var c=h=!1;void 0===g||F.get.empty(g)||(h=F.get.blocker(g),c=F.get.forbidden(g));c?(h="_forbidden",l=d.getMessage("At_least_one_part_of_this_page_is_listed_at_the_forbidden_pages_setting_")):h?(h="_blocker",l=d.getMessage("Some_scripts_might_be_blocked_by_the_javascript_settings_for_this_page_or_a_script_blocker_")):h=e.values.enabled&&void 0!==g?"":"_grey";n.debug("badge: set icon "+h);h={path:rea.extension.getURL("images/icon"+h+".png")};l={title:l?l:rea.extension.manifest.name};
null!=g&&(h.tabId=g,l.tabId=g);try{rea.browserAction.setIcon(h,m),rea.browserAction.setTitle(l)}catch(a){n.warn("bg: ERROR while setIcon! "+a.message)}},setBadge:function(d){var h=0;"off"==e.values.appearance_badges?h=0:"running"==e.values.appearance_badges?d&&!F.get.empty(d)&&(h=F.get.stats(d).running):"running_unique"==e.values.appearance_badges?d&&!F.get.empty(d)&&(h=F.get.stats(d,!0).unique):"disabled"==e.values.appearance_badges&&d&&!F.get.empty(d)&&(h=F.get.stats(d).disabled);n.debug("badge: set "+
h);h?rea.browserAction.setBadgeText({text:h.toString(),tabId:d}):rea.browserAction.setBadgeText({text:"",tabId:d})}};return q}(),da=function(){var d=null,e={init:function(){d=t.getValue(p.CONSTANTS.STORAGE.BEGGING,null);var g,h=Date.now();d?(g=t.getValue(p.CONSTANTS.STORAGE.LAST_START,0))&&12096E5<h-g&&(d.later={type:"after_pause",ts:h},e.save()):(d={first_run:{type:"from_init",ts:h}},e.save())},save:function(){t.setValue(p.CONSTANTS.STORAGE.BEGGING,d)},needed:function(){var e=Date.now(),h=d.first_run?
d.first_run.ts+12096E5<e:!0,l=!d.hide,c=!d.contributed,e=d.later?d.later.ts+12096E5<e:!0;if(!p.RUNTIME.DOLPHIN&&h&&l&&c&&e)return d.later?"l":"i"},clicked:function(d,e,l){N.tG("clicked",d,e+l)},dialog:{shown:function(g){var h=Date.now();d.dialog={ts:h,extra:g};e.save();N.tG("dialog")}},button:function(){var g={};["contributed","later","hide"].forEach(function(h){g[h]=function(g,c){var a=Date.now();d[h]={ts:a,type:g,extra:c};e.save();N.tG("button",h)}});return g}()};return e}(),ma=function(){var d=
function(a,c){n.debug(a,c);if(c&&a.menuItemId){var b=z.getByUid(a.menuItemId);b&&b.script?Ca.bundle({url:a.frameUrl||a.pageUrl||"<unknown>"},b.script,!0).then(function(b){var d=m();b.method="executeScript";a.frameUrl?b.url=B.woHash(a.frameUrl):b.topframe=!0;rea.tabs.sendMessage(c.id,b,d.resolve);return d.promise()}):n.debug("ctxm: unable to find script "+a.menuItemId,a,c)}},e=[],g=null,h=!1,l=function(a){var c=[];v.each(a,function(a){var b=m();rea.contextMenus.create({id:a.uuid,contexts:["all"],parentId:g,
title:a.name,type:"normal",documentUrlPatterns:["http://*/*","https://*/*","file://*/*"]},function(){b.resolve()});e.push(a.uuid);c.push(b.promise())});return m.when(c)},c=function(){var a=m();rea.contextMenus.removeAll(function(){g=null;a.resolve()});return a.promise()},a=function(){var a=m();c().then(function(){g=rea.contextMenus.create({contexts:["all"],title:"Tampermonkey",type:"normal",documentUrlPatterns:["http://*/*","https://*/*","file://*/*"]},function(){a.resolve()})});return a.promise()},
b=function(){var b=Y.getContexters(!0,null);if(b.length){var d;d=g?m.Pledge():a();return d.then(function(){return l(b)})}return c().then(f.clean)},f={init:function(){rea.contextMenus.supported&&(f.clean().then(b).then(function(){h=!0}),rea.contextMenus.onClicked.addListener(d))},clean:function(){var a=m();e.forEach(function(a){rea.contextMenus.remove(a)});e=[];a.resolve();return a.promise()},onScriptsChanged:function(){if(rea.contextMenus.supported&&h)return f.clean().then(b)},getContexterCount:function(){return e.length}};
return f}(),ga=function(){var d={},m={},g=("TM_"+v.createUUID().substr(0,5)).toLowerCase(),h=["x-webkit-csp","x-content-security-policy","content-security-policy"],l=rea.webRequest.extraHeaderNeeded,c=function(a,c){var b,d,e,f,g,h=a.split(";");h.forEach(function(a,c){0===a.search(/^\s*script-src /)?d=c:0===a.search(/^\s*default-src /)?e=c:0===a.search(/^\s*img-src /)&&(f=c)});var k,l;void 0!==e&&void 0===d&&(b=!0,h.push(h[e].replace(/default-src /,"script-src ")),d=h.length-1);void 0!==e&&void 0===
f&&(b=!0,h.push(h[e].replace(/default-src /,"img-src ")),f=h.length-1);void 0!==f&&(l=!1,k=h[f],-1==k.search(/'data:'/)&&(l=!0,k=k.replace(/img-src /,"img-src data: ")),-1!=k.search(/'none'/)&&(l=!0,k=k.replace(/ 'none'/,"")),l&&(h[f]=k,b=!0));void 0!==d&&(l=!1,k=h[d],-1==k.search(/'unsafe-eval'/)&&(l=!0,k=k.replace(/script-src /,"script-src 'unsafe-eval' ")),-1!=k.search(/'none'/)&&(l=!0,k=k.replace(/ 'none'/,"")),p.RUNTIME.FIREFOX&&(-1==k.search(/'unsafe-inline'/)&&(l=g=!0,k=k.replace(/script-src /,
"script-src 'unsafe-inline' ")),-1==k.search(/'strict-dynamic'/)&&-1!=k.search(/ '(nonce|sha[0-9]+)-[^\']+'/)&&(l=!0,k=k.replace(/ '(nonce|sha[0-9]+)-[^\']+'/g," *"))),l&&(h[d]=k,b=!0));void 0!==e&&(l=!1,k=h[e],g&&-1!=k.search(/ 'self'/)&&(l=!0,h[e]=k.replace(/default-src /,"default-src blob: data: ")),l&&(b=!0));return b?h.join(";"):null},a=function(a,c){var b,d,e=a.split(";");e.forEach(function(a,c){0===a.search(/^\s*sync-xhr /)&&(d=c)});var f,g;void 0!==d&&(g=!1,f=e[d],-1!=f.search(/'none'/)&&
(g=!0,f=f.replace(/ 'none'/," *")),g&&(e[d]=f,b=!0));return b?e.join(";"):null},b=function(a,c){var b,d=a.url;Object.keys(c).forEach(function(a){var e=c[a];v.each(e.rules,function(a,c){var f,g;if((f=a.selector)&&(g=a.action)){var h,k=e.id+"/"+c;(h=L.items.regexp.get(k))||(h=w.regexify({inc:f.include,match:f.match,exc:f.exclude}),L.items.regexp.set(k,h));if(w.validUrl(d,h)){g.cancel&&(n.debug("webRequest: request was canceled by script "+e.uuid,d,a,e),e.callback&&e.callback({type:"cancel",details:{rule:a,
url:d}}),b={cancel:!0});if(g.redirect){var l,m,q,p;g.redirect.url?l=g.redirect.url:(m=g.redirect.from)&&(q=g.redirect.to)&&(p=d.match(m,q))&&(p.shift(),l=q,p.concat(["","",""]).forEach(function(a,c){l=l.replace("$"+(c+1),a||"")}));f=function(c){n.warn("webRequest: error while request redirect by script "+e.uuid,d,a,e);e.callback&&e.callback({type:"redirect",message:"error",details:{description:c,rule:a,url:d,redirect_url:l}})};if(!l){f("unable to determine the redirect URL");return}l=B.woHash(l);
T.isAllowed(l)?w.scriptWillRun(e.uuid,l)?(n.debug("webRequest: request was redirected by script "+e.uuid,d,l,a,e),e.callback&&e.callback({type:"redirect",details:{rule:a,url:d,redirect_url:l}}),b={redirectUrl:l}):f("the redirect URL needs to be included by the scripts @include or @match tag"):f("the redirect URL is filtered by the security settings")}if(b)return!1}}})});return b},f=function(a){var c=[],b=a.requestHeaders||[],d,e,f={},h=new RegExp("^"+g),b=b.filter(function(b){if(b.name&&0==b.name.search(h))e=
b.name.replace(h,""),f[e.toLowerCase()]=!0,"internal"==e?m[a.requestId]=b.value:b.value&&c.push({name:e,value:J.decodeS(b.value)}),d=!0;else return!0});if(d)return{requestHeaders:b.filter(function(a){return!a.name||!f[a.name.toLowerCase()]}).concat(c)}},k=function(a){if(H.late)if("main_frame"==a.type){if(F.events.reset(a.tabId,!0),0<a.tabId&&"POST"!=a.method&&"auto"==e.values.scriptUrlDetection&&oa.isScriptUrl(a.url))return w.installFromUrl(a.url,{},{silent_fail:!0}).fail(function(c){n.info("webRequest: user script detected @ "+
a.url+" was invalid",c?c.messages:"");rea.tabs.update(a.tabId,{url:a.url+"#bypass=true"},function(){})}).done(function(){p.RUNTIME.EDGE&&rea.tabs.query({windowType:"normal"},function(c){c.forEach(function(c){c.id===a.tabId&&rea.tabs.update(c.id,{url:c.url},function(){})})})}),p.RUNTIME.EDGE?{cancel:!0}:{redirectUrl:"javascript:history.back()"}}else{var c,d;if((c=F.get.requests(a.tabId,a.frameId))&&(d=b(a,c)))return d}else H.registerLateCallback(function(){k(a)})},t=function(b,f){if(H.late){var g=
b.responseHeaders||[];if("xmlhttprequest"==b.type){var k,l;if(m[b.requestId]){p.XMLHTTPREQUEST.COOKIE_PASSTHROUGH||g.forEach(function(a){a.name&&a.value&&-1!=a.name.toLowerCase().indexOf("set-cookie")&&(g.push({name:"tm-setcookie"+rea.runtime.short_id.toLowerCase(),value:a.value}),l=!0)});if(k=d[b.requestId])g.push({name:"tm-finalurl"+rea.runtime.short_id.toLowerCase(),value:k}),l=!0;if(l)return{responseHeaders:g}}}else{var n,r,y,v,w=p.OPTIONS.HAS_CSP&&"yes"==e.values.webrequest_fixCSP,z=w&&p.RUNTIME.CHROME&&
60<=p.RUNTIME.BROWSER_VERSION;g.some(function(a){if(a.name)return a=a.name.toLowerCase(),r|="location"==a,w&&(y|=-1!=h.indexOf(a)),z&&(v|="feature-policy"==a),r});if(!r){(k=F.events.response(b.tabId,b.frameId,b.url))&&(y||v)&&g.forEach(function(d,e){if(d.name&&d.value){var f=d.name.toLowerCase();if(-1!=h.indexOf(f)){var k;if(k=c(d.value,b))n=!0,g[e]={name:d.name,value:k}}"feature-policy"==f&&(f=a(d.value,b))&&(n=!0,g[e]={name:d.name,value:f})}});var D;if(p.RUNTIME.FAST_EXEC_SUPPORT&&-1!=["instant"].indexOf(e.values.runtime_inject_mode)&&
(D=F.events.run(b.tabId,b.frameId,null,b.url))){var E=B.parse(b.url),E=E.pathname+E.search,E="TM_"+rea.runtime.short_id+J.Base64.encode(E.length+E).substr(0,255).replace(/[#=\/]/g,"_")+Date.now();D=Y.answer(D,b.url);D=JSON.stringify(D);D=new Blob([D],{type:"binary/octet-stream"});D=URL.createObjectURL(D);F.set.objurl(b.tabId,b.frameId,D);g.push({name:"set-cookie",value:E+"="+window.encodeURIComponent(D)+"; max-age=15;"});n=!0}if(k&&!f&&rea.webRequest.filterResponseData&&p.OPTIONS.HAS_CSP&&"yes"==
e.values.webrequest_fixCSP&&"yes"==e.values.webrequest_fixContentCSP&&-1!=["main_frame","sub_frame"].indexOf(b.type)){var G;g.some(function(a){if(a.name&&a.value&&"content-type"==a.name.toLowerCase()&&"text/html"==a.value.split(";")[0].toLowerCase().trim())return G=!0});if(G){var I=rea.webRequest.filterResponseData(b.requestId);I.ondata=function(a){var d=(new TextDecoder("x-user-defined")).decode(a.data,{stream:!0}),e=new RegExp('(<head>[\\s\\S]*)(<meta[^>]+http-equiv="(?:'+h.join("|")+')"[^>]*>)([\\s\\S]*?<\\/head>)',
"i"),f,d=d.replace(e,function(a,d,e,g){return d+e.replace(/(content=")([^">]+)(")/,function(a,d,e,g){if(a=c(e||"",b))f=!0;return d+(a||e)+g})+g});f?I.write(J.str2arrbuf(d)):I.write(a.data);I.disconnect();I=null};I.onstop=function(){I&&I.disconnect()}}}if(n)return p.RUNTIME.FIREFOX&&(g=g.filter(function(a){return"cache-control"!=a.name.toLowerCase()}),g.push({name:"cache-control",value:"no-cache, no-store, must-revalidate"})),{responseHeaders:g}}}}else H.registerLateCallback(function(){t(b,!0)})},
r=function(a){d[a.requestId]=a.redirectUrl},z=function(a){H.late?"xmlhttprequest"==a.type?(delete m[a.requestId],delete d[a.requestId]):a.fromCache&&F.events.response(a.tabId,a.frameId,a.url):H.registerLateCallback(function(){z(a)})},y=function(a){"xmlhttprequest"==a.type?(delete m[a.requestId],delete d[a.requestId]):F.events.reset(a.tabId,!0)};return{getPrefix:function(){return g},init:function(a){try{var c;c=p.RUNTIME.EDGE?["http://*/*","https://*/*"]:["http://*/*","https://*/*","ftp://*/*","file:///*"].concat(p.RUNTIME.WEBREQUEST_WEBSOCKET?
["ws://*/*","wss://*/*"]:[]);a?(rea.webRequest.onBeforeRequest.addListener(k,{urls:c,types:["main_frame","sub_frame","script","xmlhttprequest"].concat(p.RUNTIME.WEBREQUEST_WEBSOCKET?["websocket"]:[])},["blocking"]),rea.webRequest.onHeadersReceived.addListener(t,{urls:c,types:["main_frame","sub_frame","xmlhttprequest"]},["blocking","responseHeaders"].concat(l?["extraHeaders"]:[])),p.RUNTIME.WEBREQUEST_XHR_SUPPORT&&rea.webRequest.onBeforeRedirect.addListener(r,{urls:c,types:["xmlhttprequest"]},[]),
rea.webRequest.onResponseStarted.addListener(z,{urls:c,types:["main_frame","sub_frame","xmlhttprequest"]},[]),rea.webRequest.onErrorOccurred.addListener(y,{urls:c,types:["main_frame","xmlhttprequest"]})):p.RUNTIME.WEBREQUEST_XHR_SUPPORT&&"no"!=e.values.webrequest_modHeaders&&rea.webRequest.onBeforeSendHeaders.addListener(f,{urls:c,types:["xmlhttprequest"]},["blocking","requestHeaders"].concat(l?["extraHeaders"]:[]));rea.webRequest.handlerBehaviorChanged()}catch(b){n.warn("webRequest: error initializings",
b.message)}},scripts:{set:function(a,c,b,d,e){var f=[];d.forEach(function(a){var c="string"===typeof a.selector?{include:[a.selector]}:a.selector;["include","match","exclude"].forEach(function(c){"string"===typeof a.selector[c]&&(a.selector[c]=[a.selector[c]])});var b=a.action;if("string"===typeof b){var d=b,b={};b[d]=!0}"string"===typeof a.action.redirect&&(a.action.redirect={url:a.action.redirect});f.push({selector:c,action:b})});F.set.requests(a,c,b,{id:b+"@"+a+":"+c+"#"+Date.now(),rules:f,uuid:b,
callback:e})}}}}(),H={late:!1,callbacks:[],init:function(){},registerLateCallback:function(d){n.debug("toea: register callback");H.callbacks.push(d)},setReady:function(){n.debug("toea: run "+H.callbacks.length+" callbacks");H.late=!0;for(var d=0;d<H.callbacks.length;d++)H.callbacks[d]();H.callbacks=[]}},Ka=function(){var d=!1,e=null,g=function(){d||(n.debug("Unloader.onbeforeunload()"),e&&e(),d=!0)};return{init:function(d){e=d;window.addEventListener("beforeunload",g,!1)}}}(),za=function(){var A=
null,q=rea.extension.manifest.version,g=null,h=!1,l=!1,c=function(){if(H.late){var a="version="+q+"&ext="+rea.runtime.short_id+"&updated=true",b;h?(b="https://tampermonkey.net/installed.php?"+a,l=!0):(a+="&old="+g,b="https://tampermonkey.net/changelog.php?"+a);"off"!=e.values.notification_showUpdate&&("notification"==e.values.notification_showUpdate?S.showUpdate(d.getMessage("Updated_to__0version0",q),d.getMessage("Click_here_to_see_the_recent_changes"),rea.extension.getURL("images/icon128.png"),
function(a){a.clicked&&rea.tabs.create({url:b},function(){})}):"changelog"==e.values.notification_showUpdate&&(l||(b+="&intr=true"),l=!0,rea.tabs.create({url:b,active:l},function(){})))}else H.registerLateCallback(c)},a=function(){var a=null,b,c=m(),d=function(){b&&(b=null,c.resolve(!!a))};b=window.setTimeout(d,300);rea.idle.queryState(p.MISC.IDLE_TIMEOUT,function(b){a="active"==b;d()});return c.promise()},b=function(a){if(H.late)if(n.debug("upd: onInstalled",a),a||(a={reason:"mandatory_argument_is_not_set"}),
"chrome_update"==a.reason)N.tB({updated:!0});else{if("install"==a.reason||"update"==a.reason)"install"==a.reason&&w.foistedScriptsEverywhere(),v.scheduleNotification(a.previousVersion,"install"==a.reason)}else H.registerLateCallback(function(){b(a)})},f=function(){var a=m(),b=function(){var b=Date.now(),c=t.getValue(p.CONSTANTS.STORAGE.LAST_START,0),b=Math.round((b-c)/1E3),c=b<=p.MISC.DISTURBANCE_ALLOWED;n.debug("upd: restart?",c,"(",b,"seconds ago)");a.resolve(c)};H.late?b():H.registerLateCallback(b);
return a.promise()}(),k=function(){var b=!1,d=!1;a().then(function(a){d=a;return f}).then(function(a){b=a}).always(function(){l=!d||b;c();r=!0})},u=null,r=!1,v={scheduleNotification:function(a,b){r||(g=a,h|=b,u&&window.clearTimeout(u),u=window.setTimeout(k,1E3))},updateAvailable:function(){return A}};rea.runtime.onInstalled.addListener(b);rea.runtime.onUpdateAvailable.addListener(function(a){n.info("An update to version",a.version,"is available");A=a.version;window.setTimeout(function(){S.show(d.getMessage("Update"),
d.getMessage("0name0_0version0_is_available__Please_re_start_your_browser_to_update_",rea.extension.manifest.name,a.version),rea.extension.getURL("images/icon128.png"),6E4)},864E5)});(function(){H.registerLateCallback(function(){t.setValue(p.CONSTANTS.STORAGE.LAST_START,Date.now())})})();return v}(),La=function(d){(function(){var n=m();"toggle-enable"==d?(e.values.enabled=!e.values.enabled,n.resolve()):rea.tabs.getSelected(null,function(e){var h;"open-dashboard"==d?h=rea.extension.getURL("options.html")+
"#nav=dashboard":"open-dashboard-with-running-scripts"==d?h=rea.extension.getURL("options.html")+"#nav=dashboard&filter="+encodeURIComponent(e.url):"open-new-script"==d&&(h=rea.extension.getURL("options.html")+"#url="+J.Base64.encode(e.url)+"&nav=new-user-script");n.resolve(h?{url:h,active:!0,parent:e}:null)});return n.promise()})().then(function(d){d&&rea.tabs.create(d)})},va=function(){var d=[],m=function(a,b,c){H.late?("auto"==e.values.scriptUrlDetection&&oa.isScriptUrl(c.url)&&w.installFromUrl(c.url,
{},{silent_fail:!0}),c.url?"loading"==b.status?F.events.loading(c.id,0,c.url):"complete"==b.status&&F.events.complete(c.id,0,c.url):n.warn("tabUpdates: no tab url set! ",c),d.forEach(function(a){a({reason:"updated",status:b.status},c)})):window.setTimeout(function(){m(a,b,c)},100)},g=function(a,b){fa[a]&&(fa[a].onClose(),delete fa[a]);F.events.remove(a);d.forEach(function(b){b({reason:"removed"},{id:a})})},h=function(a,b){g(b,{});R.setIcon(a);R.setBadge(a);d.forEach(function(b){b({reason:"replaced"},
a)})},l=function(a){H.late?(F.events.commited(a.tabId,a.frameId,a.url),0===a.frameId&&d.forEach(function(b){b({reason:"commited"},{url:a.url,id:a.tabId})})):window.setTimeout(function(){l(a)},100)},c={init:function(){rea.tabs.onUpdated.addListener(m);rea.tabs.onRemoved.addListener(g);rea.tabs.onReplaced.addListener(h);rea.webNavigation.supported&&rea.webNavigation.onCommitted.addListener(l)},openAndWatch:function(a,b){var d=null,e=function(a,g){null!==d&&g.id===d&&(-1!=["updated","commited"].indexOf(a.reason)?
b(g):"removed"==a.reason&&(c.removeListener(e),b()))};rea.tabs.create(a,function(a){d=a.id;b(a)});c.addListener(e);return{cancel:function(){c.removeListener(e);null!==d&&(rea.tabs.remove(d,function(){}),d=null)}}},addListener:function(a){d.push(a)},removeListener:function(a){var b;d&&-1<(b=d.indexOf(a))&&d.splice(b,1)}};return c}(),Da=function(){var d="temporary"==e.values.incognito_mode&&rea.extension.inIncognitoContext;t.setTemporary(d);d&&(e.values.native_import=!1,e.values.sync_enabled=!1,e.values.scriptUpdateCheckPeriod=
0,e.values.sync_type=0,e.values.statistics_enabled=!1)},Ma=function(){n.set(e.values.logLevel);d.setLocale(e.values.i18n);Q.setPath(e.values.native_import_path);var m=p.RUNTIME.WEBREQUEST_XHR_SUPPORT&&"no"!=e.values.webrequest_modHeaders;ba=Registry.get("xmlhttprequest");ba.setConfig({prefix:m?ga.getPrefix():null,mozAnon:p.RUNTIME.FIREFOX});aa.init();N.init("bg",rea.extension.manifest.version);N.setEnabled(e.values.statistics_enabled);F.listeners.add.onReset(function(d,e){ea.clearByTabId(d);z.removeStorageListeners({tabid:d},
!1);e||R.setIcon(d)});m=function(d){rea.tabs.get(d,function(e){!rea.runtime.lastError&&e&&(R.setIcon(d),R.setBadge(d))})};F.listeners.add.onCommited(m);F.listeners.add.onCompleted(m);F.listeners.add.onCompleted(ha.purgeAppeals);F.listeners.add.onRemoved(ha.purgeAppeals);F.listeners.add.onRemoved(na.cleanTab);M.init().done(function(d){d&&M.sync()});T.init();K.init();z.init();m=function(){I.set_mode(e.values.downloads_mode);I.set_whitelist(e.values.downloads_extension_whitelist)};m();I.config_changed_listener=
m;sa.init();ga.init();ma.init();da.init();ca.init()},ba,qa,E,G,ua;init=function(){H.init();ga.init(!0);va.init();Aa.init();rea.commands.supported&&rea.commands.onCommand.addListener(La);Ka.init(function(){M.finalize()});qa=Registry.get("compat",p);E=Registry.get("parser");G=Registry.get("syncinfo",va);ua=Registry.get("test");rea.browserAction.setIcon({path:rea.extension.getURL("images/icon_grey.png")});rea.browserAction.setPopup({popup:"action.html"});rea.browserAction.setTitle({title:"Tampermonkey"});
t.init().then(function(){return Ea()}).then(function(){return e.init()}).then(function(){cfgo=e;Da();Ma();Ha();R.init();window.setTimeout(ca.check,1E4);n.debug("Listeners registered!");window.setTimeout(H.setReady,1)})};init()}});
